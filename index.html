<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BlueBuy Shopping List</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* Custom Scrollbar & Utils */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 20px;
        }
        .animate-fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        body {
            -webkit-tap-highlight-color: transparent;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        /* Mobile layout fixes */
        .mobile-height {
            height: 100dvh; /* dynamic viewport height */
        }
    </style>
</head>
<body class="bg-[#FFF9F5] text-slate-600 overflow-hidden selection:bg-blue-100">

    <div id="app" class="mobile-height w-full flex flex-col md:flex-row relative">
        </div>

    <div id="apiKeyModal" class="fixed inset-0 bg-black/60 z-[100] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-[2rem] shadow-2xl w-full max-w-sm p-8 text-center border-4 border-white/50">
            <div class="w-16 h-16 bg-blue-100 text-blue-500 rounded-full flex items-center justify-center mx-auto mb-4">
                <i data-lucide="key" class="w-8 h-8"></i>
            </div>
            <h2 class="text-xl font-bold text-slate-800 mb-2">è¨­å®š API Key</h2>
            <p class="text-slate-500 text-sm mb-6">è«‹è¼¸å…¥æ‚¨çš„ Google Gemini API Key ä»¥å•Ÿç”¨ AI åŠŸèƒ½ã€‚</p>
            <input type="password" id="apiKeyInput" placeholder="Paste API Key here..." class="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl mb-4 focus:ring-2 focus:ring-blue-400 outline-none text-center font-bold">
            <button onclick="saveApiKey()" class="w-full py-3 bg-blue-500 hover:bg-blue-600 text-white rounded-2xl font-bold shadow-lg shadow-blue-200 transition-all active:scale-95">
                é–‹å§‹ä½¿ç”¨
            </button>
        </div>
    </div>

    <script>
        // --- State Management ---
        const generateId = () => Math.random().toString(36).substr(2, 9);
        
        // Initial Data Structure
        const initialData = [
          {
            id: 'folder-1',
            type: 'folder',
            title: 'ä¾¿åˆ©å•†åº— ğŸª',
            isOpen: true,
            children: [
              {
                id: 'list-1',
                type: 'list',
                title: '7-ELEVEN',
                groups: [
                   { id: 'group-1', title: 'é£²æ–™ Drinks', isOpen: true },
                   { id: 'group-2', title: 'ç†Ÿé£Ÿ Food', isOpen: true }
                ],
                items: [
                  {
                    id: 'item-1',
                    name: 'å¾¡é£¯ç³°',
                    price: 35,
                    currency: 'TWD',
                    note: 'é®ªé­šå£å‘³',
                    ingredients: 'ç™½ç±³ã€é®ªé­šã€æµ·è‹”ã€ç¾ä¹ƒæ»‹ (ç†±é‡ç´„ 200å¤§å¡)',
                    locations: ['7-ELEVEN'],
                    links: [],
                    image: 'https://loremflickr.com/300/300/onigiri',
                    checked: false,
                    groupId: 'group-2'
                  }
                ]
              }
            ]
          }
        ];

        const CURRENCIES = ['TWD', 'USD', 'JPY', 'EUR', 'KRW'];

        // Global State
        const state = {
            apiKey: localStorage.getItem('bluebuy_apiKey') || '',
            structure: JSON.parse(localStorage.getItem('bluebuy_data')) || initialData,
            sidebarOpen: true,
            sidebarTab: 'lists',
            selectedListId: null, // Will default to first list logic
            viewMode: 'list',
            loading: false,
            isSaving: false,
            newItemName: '',
            
            // Modal States
            modals: {
                restaurant: false,
                hotel: false,
                aiRec: false,
                aiImport: false,
                listSelector: false,
                editor: false,
                dialog: { isOpen: false, type: 'alert', title: '', message: '', inputValue: '', onConfirm: null }
            },
            
            // Temporary data for modals
            pendingItem: null,
            editingItem: null,
            aiResults: null, 
            isProcessingAI: false
        };

        // --- Helpers ---
        function saveToStorage() {
            state.isSaving = true;
            render();
            localStorage.setItem('bluebuy_data', JSON.stringify(state.structure));
            setTimeout(() => {
                state.isSaving = false;
                render();
            }, 500);
        }

        function getAllergens(text) {
            if (!text) return [];
            const features = [];
            if (text.match(/è¾£|æ¤’|è¾›|éº»è¾£|ä¸ƒå‘³/)) features.push({ emoji: 'ğŸŒ¶ï¸', color: 'text-rose-500', bg: 'bg-rose-50', label: 'è¾›è¾£' });
            if (text.match(/å¥¶|ä¹³|èµ·å¸|èµ·å£«|å¥¶æ²¹|å¸ƒä¸|å„ªæ ¼/)) features.push({ emoji: 'ğŸ¥›', color: 'text-sky-500', bg: 'bg-sky-50', label: 'ä¹³è£½å“' });
            if (text.match(/è¦|èŸ¹|è²|é­š|æµ·é®®|æ˜å¤ª/)) features.push({ emoji: 'ğŸ¦', color: 'text-indigo-500', bg: 'bg-indigo-50', label: 'æµ·é®®' });
            if (text.match(/èŠ±ç”Ÿ|å …æœ|æ ¸æ¡ƒ|æä»|è…°æœ|èŠéº»/)) features.push({ emoji: 'ğŸ¥œ', color: 'text-amber-600', bg: 'bg-amber-50', label: 'å …æœ' });
            if (text.match(/éº¥|éºµç²‰|éºµåŒ…|éº©è³ª/)) features.push({ emoji: 'ğŸ', color: 'text-yellow-600', bg: 'bg-yellow-50', label: 'éº©è³ª' });
            return features;
        }

        function findList(nodes, id) {
            for (const node of nodes) {
                if (node.id === id && node.type === 'list') return node;
                if (node.children) { const found = findList(node.children, id); if (found) return found; }
            }
            return null;
        }

        // --- Gemini API ---
        async function callGemini(prompt, schema = null, useSearch = false) {
            if (!state.apiKey) {
                alert("è«‹å…ˆè¨­å®š API Key");
                return;
            }

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: { responseMimeType: "application/json" }
            };
            if (schema) payload.generationConfig.responseSchema = schema;
            if (useSearch) payload.tools = [{ google_search: {} }];

            try {
                const response = await fetch(
                    `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${state.apiKey}`,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    }
                );

                if (!response.ok) throw new Error(`API Error: ${response.status}`);
                
                const data = await response.json();
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!text) throw new Error("Empty response");

                let cleanText = text.replace(/```json/g, '').replace(/```/g, '').trim();
                const start = cleanText.indexOf('{');
                const end = cleanText.lastIndexOf('}');
                if (start !== -1 && end !== -1) {
                    cleanText = cleanText.substring(start, end + 1);
                }
                return JSON.parse(cleanText);
            } catch (error) {
                console.error("Gemini API Error", error);
                throw error;
            }
        }

        // --- Core Logic Actions ---

        function toggleFolder(id) {
            const toggleDeep = (nodes) => nodes.map(node => {
                if (node.id === id) return { ...node, isOpen: !node.isOpen };
                if (node.children) return { ...node, children: toggleDeep(node.children) };
                return node;
            });
            state.structure = toggleDeep(state.structure);
            saveToStorage();
        }

        function selectList(id) {
            state.selectedListId = id;
            if (window.innerWidth < 768) state.sidebarOpen = false;
            render();
        }

        function addItem(e) {
            if (e) e.preventDefault();
            const input = document.getElementById('mainInput');
            const val = input.value.trim();
            if (!val || !state.selectedListId) return;

            const newItem = { id: generateId(), name: val, price: 0, currency: 'TWD', note: '', ingredients: '', links: [], image: '', checked: false, groupId: null };
            
            const addDeep = (nodes) => nodes.map(n => {
                if (n.id === state.selectedListId) return { ...n, items: [newItem, ...n.items] };
                if (n.children) return { ...n, children: addDeep(n.children) };
                return n;
            });

            state.structure = addDeep(state.structure);
            state.newItemName = ''; // Reset
            state.editingItem = newItem;
            state.modals.editor = true;
            saveToStorage();
        }

        function toggleCheck(itemId) {
            const togDeep = (nodes) => nodes.map(n => {
                if (n.type === 'list') return { ...n, items: n.items.map(i => i.id === itemId ? { ...i, checked: !i.checked } : i) };
                if (n.children) return { ...n, children: togDeep(n.children) };
                return n;
            });
            state.structure = togDeep(state.structure);
            saveToStorage();
        }

        function deleteItem(itemId) {
            openDialog('confirm', 'åˆªé™¤å•†å“', 'ç¢ºå®šè¦åˆªé™¤é€™å€‹å•†å“å—ï¼Ÿ', () => {
                const delDeep = (nodes) => nodes.map(n => {
                    if (n.type === 'list') return { ...n, items: n.items.filter(i => i.id !== itemId) };
                    if (n.children) return { ...n, children: delDeep(n.children) };
                    return n;
                });
                state.structure = delDeep(state.structure);
                if (state.modals.editor && state.editingItem?.id === itemId) state.modals.editor = false;
                saveToStorage();
            });
        }

        function openEditModal(item) {
            state.editingItem = JSON.parse(JSON.stringify(item)); // Clone
            state.modals.editor = true;
            render();
        }

        function saveEditedItem() {
            // Collect data from DOM
            const item = state.editingItem;
            // (In a full app, we'd bind inputs, here we assume state.editingItem is updated by input events)
            
            const saveDeep = (nodes) => nodes.map(n => {
                if (n.type === 'list') return { ...n, items: n.items.map(i => i.id === item.id ? item : i) };
                if (n.children) return { ...n, children: saveDeep(n.children) };
                return n;
            });
            state.structure = saveDeep(state.structure);
            state.modals.editor = false;
            state.editingItem = null;
            saveToStorage();
        }

        // --- AI Actions ---
        async function runRestaurantSearch() {
            const query = document.getElementById('restaurantInput').value;
            if (!query) return;
            state.isProcessingAI = true;
            render();
            
            try {
                const prompt = `Search Google Maps for restaurant: "${query}". Analyze reviews and info. Return JSON: { "name": "Full Name", "rating": 4.5, "total_reviews": "100+", "address": "Address", "summary": "Concise summary in Traditional Chinese", "popular_dishes": ["Dish 1", "Dish 2"], "image_keyword": "keyword" }`;
                state.aiResults = await callGemini(prompt, null, true);
            } catch(e) {
                openDialog('alert', 'éŒ¯èª¤', 'åˆ†æå¤±æ•—ï¼Œè«‹é‡è©¦ã€‚');
            } finally {
                state.isProcessingAI = false;
                render();
            }
        }

        // --- Dialog / Modal Logic ---
        function openDialog(type, title, message, onConfirm) {
            state.modals.dialog = { isOpen: true, type, title, message, inputValue: '', onConfirm };
            render();
            // Focus input if prompt
            if (type === 'prompt') setTimeout(() => document.getElementById('dialogInput')?.focus(), 100);
        }

        function closeDialog() {
            state.modals.dialog.isOpen = false;
            render();
        }

        function handleDialogConfirm() {
            const val = document.getElementById('dialogInput')?.value;
            if (state.modals.dialog.onConfirm) state.modals.dialog.onConfirm(val);
            closeDialog();
        }

        // --- Rendering (The HTML Generator) ---

        function renderIcon(name, size = 16, className = '') {
            return `<i data-lucide="${name}" class="${className}" style="width:${size}px; height:${size}px;"></i>`;
        }

        function renderSidebarItem(node, level = 0) {
            const paddingLeft = level * 16 + 24;
            const isSelected = node.id === state.selectedListId;
            
            if (node.type === 'folder') {
                return `
                <div class="my-2">
                    <div onclick="toggleFolder('${node.id}')" class="group flex items-center justify-between py-3 pr-3 cursor-pointer text-slate-600 transition-all mr-2 rounded-r-full hover:bg-blue-50" style="padding-left: ${paddingLeft}px">
                        <div class="flex items-center gap-2 font-bold tracking-wide overflow-hidden">
                            ${node.isOpen ? renderIcon('chevron-down', 16, 'text-blue-400') : renderIcon('chevron-right', 16, 'text-slate-400')}
                            ${renderIcon('folder', 18, 'text-blue-400 fill-blue-50')}
                            <span class="truncate text-sm">${node.title}</span>
                        </div>
                        <div class="flex gap-1 opacity-100 md:opacity-0 md:group-hover:opacity-100 transition-opacity">
                            <button onclick="event.stopPropagation(); addListPrompt('${node.id}')" class="p-1.5 text-blue-400 hover:text-blue-600 bg-white rounded-full shadow-sm border border-slate-100">${renderIcon('plus', 14)}</button>
                        </div>
                    </div>
                    ${node.isOpen && node.children ? `
                        <div class="relative">
                            <div class="absolute left-[33px] top-0 bottom-4 w-0.5 border-l-2 border-dotted border-blue-200 ml-4"></div>
                            ${node.children.map(child => renderSidebarItem(child, level + 1)).join('')}
                        </div>
                    ` : ''}
                </div>`;
            } else {
                return `
                <div class="my-2">
                    <div onclick="selectList('${node.id}')" class="group flex items-center justify-between py-3 pr-3 cursor-pointer transition-all mr-2 rounded-r-full ${isSelected ? 'bg-blue-100 text-blue-600 font-bold' : 'text-slate-500 hover:bg-slate-100'}" style="padding-left: ${paddingLeft}px">
                        <div class="flex items-center gap-2 overflow-hidden">
                            <div class="w-2 h-2 rounded-full flex-shrink-0 ${isSelected ? 'bg-blue-500' : 'bg-slate-300'}"></div>
                            <span class="truncate tracking-wide text-sm">${node.title}</span>
                        </div>
                        <span class="text-[10px] px-2 py-0.5 rounded-full font-bold ${isSelected ? 'bg-white text-blue-500' : 'bg-slate-200 text-slate-500'}">${node.items?.length || 0}</span>
                    </div>
                </div>`;
            }
        }

        function renderItemCard(item) {
            const allergens = getAllergens(item.name + (item.ingredients || ''));
            const isGrid = state.viewMode === 'grid';
            
            // Item Logic
            const imageHtml = item.image 
                ? `<img src="${item.image}" alt="${item.name}" class="w-full h-full object-cover">` 
                : `<div class="w-full h-full flex items-center justify-center text-slate-300">${renderIcon('image', 20)}</div>`;

            return `
            <div class="group relative bg-white rounded-[24px] transition-all duration-300 overflow-hidden border border-slate-100 ${item.checked ? 'opacity-50 bg-slate-50 shadow-none grayscale' : 'shadow-[0_10px_30px_-10px_rgba(224,231,255,0.7)] hover:shadow-[0_15px_35px_-10px_rgba(224,231,255,0.9)] hover:-translate-y-1'} ${isGrid ? 'p-4 flex flex-col' : 'p-5 flex gap-4 items-start'}" onclick="openEditModal(${JSON.stringify(item).replace(/"/g, '&quot;')})">
                
                ${!isGrid ? `
                <button onclick="event.stopPropagation(); toggleCheck('${item.id}')" class="flex-shrink-0 w-8 h-8 rounded-full border-[3px] flex items-center justify-center transition-all mt-1 ${item.checked ? 'bg-blue-300 border-blue-300 text-white' : 'border-slate-200 text-transparent hover:border-blue-300'}">
                    ${renderIcon('check', 16)}
                </button>
                <div class="w-16 h-16 bg-slate-50 rounded-2xl overflow-hidden flex-shrink-0 border-2 border-white shadow-sm mt-0.5 object-cover">
                    ${imageHtml}
                </div>` : ''}

                ${isGrid ? `
                 <div class="relative">
                     <div class="w-full aspect-video bg-slate-50 rounded-2xl overflow-hidden mb-3 border-2 border-white shadow-sm">${imageHtml}</div>
                     <button onclick="event.stopPropagation(); toggleCheck('${item.id}')" class="absolute top-2 right-2 w-8 h-8 rounded-full border-[3px] flex items-center justify-center bg-white shadow-md ${item.checked ? 'border-blue-300 text-blue-400' : 'border-slate-200 text-slate-200'}">${renderIcon('check', 16)}</button>
                 </div>
                ` : ''}

                <div class="flex-1 min-w-0 flex flex-col gap-2">
                    <div class="flex justify-between items-start gap-2">
                        <h3 class="font-bold text-base leading-snug break-words tracking-wide ${item.checked ? 'line-through text-slate-400' : 'text-slate-700'}">${item.name}</h3>
                        ${item.price > 0 ? `<div class="flex-shrink-0 font-bold text-blue-500 bg-blue-50 px-3 py-1.5 rounded-2xl text-xs whitespace-nowrap">${item.currency === 'JPY' ? 'Â¥' : '$'}${item.price}</div>` : ''}
                    </div>
                    
                    <div class="flex flex-wrap gap-1.5">
                        ${allergens.map(t => `<div class="flex items-center gap-1 text-[10px] font-bold px-2 py-0.5 rounded-lg ${t.bg} ${t.color}">${t.emoji} ${t.label}</div>`).join('')}
                    </div>

                    ${item.note ? `<p class="text-xs text-slate-500 break-all bg-slate-50 px-2.5 py-1 rounded-xl font-medium inline-block w-fit">${item.note}</p>` : ''}
                </div>
                
                ${!isGrid ? `
                <div class="flex flex-col gap-1.5 md:opacity-0 group-hover:opacity-100 transition-opacity absolute right-3 bottom-3 md:static md:bg-transparent md:flex-row md:self-center bg-white/90 p-1 rounded-xl shadow-sm md:shadow-none">
                     <button onclick="event.stopPropagation(); deleteItem('${item.id}')" class="p-2.5 text-slate-400 hover:text-rose-400 hover:bg-rose-50 rounded-full transition-colors">${renderIcon('trash-2', 18)}</button>
                </div>` : ''}
            </div>
            `;
        }

        function renderEditorModal() {
            if (!state.modals.editor || !state.editingItem) return '';
            const item = state.editingItem;
            
            // Helper to update temp state
            window.updateEditField = (field, value) => { state.editingItem[field] = value; };

            return `
            <div class="fixed inset-0 bg-black/30 backdrop-blur-sm z-50 flex justify-end">
                <div class="w-full max-w-md bg-[#FFF9F5] h-full shadow-2xl flex flex-col border-l-4 border-white animate-fade-in">
                    <div class="p-5 border-b border-blue-50 flex items-center justify-between bg-white z-10">
                        <h3 class="text-base font-bold text-slate-700 flex items-center gap-2">
                            <span class="bg-blue-100 p-2 rounded-xl text-blue-500">${renderIcon('edit-3', 20)}</span> ç·¨è¼¯å¥½ç‰©
                        </h3>
                        <div class="flex items-center gap-2">
                            <button onclick="saveEditedItem()" class="bg-blue-500 hover:bg-blue-600 text-white px-5 py-2 rounded-full font-bold shadow-md transition-all text-sm flex items-center gap-1">${renderIcon('check', 16)} å„²å­˜</button>
                            <button onclick="state.modals.editor = false; render()" class="p-2 hover:bg-slate-100 rounded-full text-slate-400 transition-colors">${renderIcon('x', 24)}</button>
                        </div>
                    </div>
                    <div class="flex-1 overflow-y-auto p-6 space-y-6 custom-scrollbar">
                        <div class="space-y-3">
                            <label class="text-xs font-bold text-slate-400 uppercase ml-1">å•†å“åç¨±</label>
                            <input type="text" value="${item.name}" oninput="updateEditField('name', this.value)" class="w-full p-4 bg-white border-2 border-transparent focus:border-blue-200 rounded-2xl focus:outline-none shadow-sm text-slate-700 font-bold text-lg" placeholder="åç¨±...">
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div class="space-y-2">
                                <label class="text-xs font-bold text-slate-400 uppercase ml-1">åƒ¹æ ¼</label>
                                <input type="number" value="${item.price}" oninput="updateEditField('price', this.value)" class="w-full p-4 bg-white border-0 rounded-2xl shadow-sm text-slate-700 font-bold focus:ring-2 focus:ring-blue-100 text-lg">
                            </div>
                             <div class="space-y-2">
                                <label class="text-xs font-bold text-slate-400 uppercase ml-1">è²¨å¹£</label>
                                <select onchange="updateEditField('currency', this.value)" class="w-full p-4 bg-white border-0 rounded-2xl shadow-sm font-medium text-lg">
                                    ${CURRENCIES.map(c => `<option value="${c}" ${c === item.currency ? 'selected' : ''}>${c}</option>`).join('')}
                                </select>
                            </div>
                        </div>
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-slate-400 uppercase ml-1">å€‹äººå‚™è¨»</label>
                            <textarea oninput="updateEditField('note', this.value)" rows="3" class="w-full p-4 bg-white border-0 rounded-2xl shadow-sm resize-none text-slate-600 leading-relaxed focus:ring-2 focus:ring-blue-100 text-base">${item.note}</textarea>
                        </div>
                        <div class="space-y-2">
                             <label class="text-xs font-bold text-slate-400 uppercase ml-1">åœ–ç‰‡é€£çµ</label>
                             <input type="text" value="${item.image}" oninput="updateEditField('image', this.value)" class="w-full p-4 bg-white border-0 rounded-2xl shadow-sm text-sm" placeholder="https://...">
                             ${item.image ? `<img src="${item.image}" class="w-full h-40 object-cover rounded-2xl mt-2">` : ''}
                        </div>
                        <div class="h-12"></div>
                    </div>
                </div>
            </div>`;
        }

        // --- Main Render Function ---
        function render() {
            const app = document.getElementById('app');
            
            // 1. Sidebar
            const sidebarHtml = `
            <aside class="absolute md:relative z-30 h-full bg-white w-72 flex flex-col transition-transform duration-300 ease-in-out shadow-[4px_0_40px_-10px_rgba(219,234,254,0.6)] ${state.sidebarOpen ? 'translate-x-0' : '-translate-x-full md:translate-x-0 md:w-72'}">
                <div class="p-8 pb-4 flex items-center gap-3">
                    <div class="w-12 h-12 bg-blue-100 rounded-[20px] -rotate-6 flex items-center justify-center text-blue-500 shadow-inner">${renderIcon('shopping-bag', 24)}</div>
                    <h1 class="text-xl font-black text-slate-700 tracking-wider">BlueBuy</h1>
                </div>
                <div class="flex-1 overflow-y-auto p-4 space-y-2 custom-scrollbar relative">
                    ${state.sidebarTab === 'lists' ? `
                        <div class="flex justify-between items-center mb-2 px-2">
                            <span class="text-xs font-bold text-slate-400 uppercase tracking-widest">æˆ‘çš„æ¸…å–®</span>
                            <button onclick="addFolderPrompt()" class="p-1.5 text-blue-400 hover:bg-blue-50 rounded-full transition-colors">${renderIcon('plus', 14)}</button>
                        </div>
                        ${state.structure.map(node => renderSidebarItem(node)).join('')}
                    ` : `
                        <div class="space-y-4 px-2 animate-fade-in">
                           <div class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-2">AI æ™ºæ…§å·¥å…·</div>
                           <button onclick="state.modals.restaurant = true; render()" class="flex flex-col items-center justify-center gap-2 bg-orange-50 hover:bg-orange-100 text-orange-500 py-4 rounded-3xl transition-all active:scale-95 border-2 border-orange-100 w-full">
                               ${renderIcon('utensils', 20)} <span class="text-xs font-bold">é¤å»³æ¢æŸ¥</span>
                           </button>
                           <p class="text-xs text-center text-slate-400">æ›´å¤šåŠŸèƒ½é–‹ç™¼ä¸­...</p>
                        </div>
                    `}
                </div>
                <div class="p-4 border-t border-slate-100 bg-white">
                    <div class="flex bg-slate-100 p-1 rounded-2xl">
                        <button onclick="state.sidebarTab = 'lists'; render()" class="flex-1 py-2.5 rounded-xl text-sm font-bold flex items-center justify-center gap-2 transition-all ${state.sidebarTab === 'lists' ? 'bg-white text-blue-500 shadow-sm' : 'text-slate-400'}">${renderIcon('menu', 16)} æ¸…å–®</button>
                        <button onclick="state.sidebarTab = 'tools'; render()" class="flex-1 py-2.5 rounded-xl text-sm font-bold flex items-center justify-center gap-2 transition-all ${state.sidebarTab === 'tools' ? 'bg-white text-blue-500 shadow-sm' : 'text-slate-400'}">${renderIcon('grid-2x2', 16)} å·¥å…·</button>
                    </div>
                </div>
            </aside>`;

            // 2. Main Content
            const activeList = findList(state.structure, state.selectedListId);
            
            const mainHtml = `
            <main class="flex-1 flex flex-col h-full relative w-full bg-[#FFF9F5]">
                <header class="h-24 flex items-center px-6 md:px-8 justify-between sticky top-0 z-10 bg-[#FFF9F5]/90 backdrop-blur-md">
                     <div class="flex items-center gap-5 flex-1 min-w-0">
                        <button onclick="state.sidebarOpen = !state.sidebarOpen; render()" class="md:hidden p-3 -ml-2 text-slate-400 hover:bg-white rounded-2xl transition-colors">${renderIcon('menu', 24)}</button>
                        <div class="flex flex-col min-w-[5rem]"><h2 class="text-2xl font-black text-slate-700 truncate tracking-tight">${activeList ? activeList.title : 'é¸æ“‡æ¸…å–®'}</h2></div>
                        ${activeList ? `<span class="bg-white text-blue-400 text-xs font-bold px-3 py-1.5 rounded-full shadow-sm flex-shrink-0 border-2 border-white ring-2 ring-blue-50">${activeList.items.length}</span>` : ''}
                    </div>
                     <div class="flex items-center gap-3">
                         <div class="flex items-center gap-1.5 text-xs font-bold px-4 py-2 rounded-full transition-colors ${state.isSaving ? 'text-blue-400 bg-blue-50' : 'text-slate-300'}">
                            ${state.isSaving ? `${renderIcon('loader-2', 12, 'animate-spin')} å„²å­˜ä¸­` : `${renderIcon('cloud', 12)} å·²å„²å­˜`}
                         </div>
                         <button onclick="state.viewMode = state.viewMode === 'list' ? 'grid' : 'list'; render()" class="p-3 rounded-2xl hover:bg-white text-slate-500 transition-colors shadow-sm border border-transparent hover:border-slate-100">${state.viewMode === 'list' ? renderIcon('layout-grid', 20) : renderIcon('align-justify', 20)}</button>
                     </div>
                </header>

                <div class="flex-1 overflow-y-auto px-6 md:px-8 pb-10 scroll-smooth">
                    ${!activeList ? `
                        <div class="h-full flex flex-col items-center justify-center text-slate-300 gap-8 opacity-60">
                            <div class="w-48 h-48 bg-white rounded-[3rem] flex items-center justify-center shadow-[0_20px_50px_-10px_rgba(203,213,225,0.5)]">${renderIcon('shopping-bag', 80, 'text-blue-100')}</div>
                            <p class="text-xl tracking-widest font-bold">è«‹é¸æ“‡æ¸…å–®é–‹å§‹è³¼ç‰© ğŸ›’</p>
                        </div>
                    ` : `
                        <div class="max-w-4xl mx-auto space-y-10">
                             <form onsubmit="addItem(event)" class="relative group">
                                <div class="absolute inset-y-0 left-7 flex items-center pointer-events-none">${renderIcon('plus', 26, 'text-blue-300')}</div>
                                <input type="text" id="mainInput" placeholder="æƒ³è¦è²·ä»€éº¼å‘¢..." autocomplete="off" class="w-full py-6 md:py-7 bg-white rounded-[2.5rem] shadow-[0_15px_35px_-10px_rgba(147,197,253,0.25)] focus:outline-none focus:ring-4 focus:ring-blue-100 transition-all text-lg md:text-xl placeholder:text-slate-300 text-slate-600 font-bold pl-16 md:pl-20 pr-24">
                                <button type="submit" class="absolute right-3 top-3 bottom-3 px-6 md:px-8 bg-blue-400 hover:bg-blue-500 text-white rounded-[2rem] font-bold transition-all active:scale-95 shadow-lg shadow-blue-200 text-lg">åŠ å…¥</button>
                             </form>

                             <div class="${state.viewMode === 'grid' ? 'grid grid-cols-1 sm:grid-cols-2 gap-4' : 'space-y-5'} pb-20">
                                 ${activeList.items.length === 0 ? '<div class="text-center py-20 text-slate-300 font-medium tracking-wide">æ¸…å–®ç©ºç©ºçš„ï¼ŒåŠ é»æ±è¥¿å§ï¼ âœ¨</div>' : ''}
                                 ${activeList.items.map(item => renderItemCard(item)).join('')}
                             </div>
                        </div>
                    `}
                </div>
            </main>
            `;

            // 3. Modals Overlay
            const modalOverlays = `
                ${state.sidebarOpen ? `<div class="fixed inset-0 bg-slate-400/20 z-20 md:hidden backdrop-blur-sm" onclick="state.sidebarOpen = false; render()"></div>` : ''}
                
                ${state.modals.dialog.isOpen ? `
                <div class="fixed inset-0 bg-black/40 z-[100] flex items-center justify-center p-4">
                    <div class="bg-white rounded-[2rem] shadow-2xl w-full max-w-sm p-6 border-4 border-white/50 animate-fade-in">
                        <div class="flex flex-col items-center text-center gap-3 mb-5">
                            <div class="w-14 h-14 bg-blue-100 text-blue-500 rounded-full flex items-center justify-center">${renderIcon(state.modals.dialog.type === 'confirm' ? 'alert-triangle' : 'edit-3', 28)}</div>
                            <h3 class="text-base font-bold text-slate-700">${state.modals.dialog.title}</h3>
                        </div>
                        <p class="text-slate-600 mb-6 text-center font-medium text-sm leading-relaxed">${state.modals.dialog.message}</p>
                        ${state.modals.dialog.type === 'prompt' ? `<input id="dialogInput" type="text" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl mb-6 focus:ring-2 focus:ring-blue-400 text-slate-700 text-center outline-none font-bold" placeholder="è¼¸å…¥...">` : ''}
                        <div class="flex justify-center gap-3">
                            <button onclick="closeDialog()" class="flex-1 py-3 text-slate-500 hover:bg-slate-100 rounded-2xl font-bold transition-colors text-sm">å–æ¶ˆ</button>
                            <button onclick="handleDialogConfirm()" class="flex-1 py-3 text-white rounded-2xl font-bold shadow-md ${state.modals.dialog.type === 'confirm' ? 'bg-rose-500' : 'bg-blue-500'}">ç¢ºèª</button>
                        </div>
                    </div>
                </div>` : ''}

                ${state.modals.restaurant ? `
                <div class="fixed inset-0 bg-slate-500/40 z-[60] flex items-center justify-center p-4">
                    <div class="bg-[#FFF9F5] rounded-[2.5rem] shadow-2xl w-full max-w-lg h-[85vh] flex flex-col overflow-hidden border-4 border-white animate-fade-in">
                         <div class="p-6 bg-white/80 border-b border-orange-50 flex-shrink-0 flex justify-between items-center">
                            <h3 class="text-base font-bold flex items-center gap-2 text-slate-700">${renderIcon('utensils', 24, 'text-orange-400')} é¤å»³æ¢æŸ¥</h3>
                            <button onclick="state.modals.restaurant=false; render()" class="bg-slate-100 p-2 rounded-full text-slate-400">${renderIcon('x', 20)}</button>
                         </div>
                         <div class="flex-1 overflow-y-auto p-6 bg-[#FDFBF7] space-y-6 custom-scrollbar">
                            ${state.isProcessingAI ? `<div class="flex flex-col items-center justify-center h-full text-orange-400 gap-4">${renderIcon('loader-2', 40, 'animate-spin')}<p>AI åˆ†æä¸­...</p></div>` : 
                              state.aiResults ? `
                                <div class="bg-white p-5 rounded-3xl shadow-sm border border-orange-100">
                                    <h2 class="text-xl font-bold text-slate-800 mb-2">${state.aiResults.name}</h2>
                                    <div class="p-3 bg-slate-50 rounded-2xl text-sm text-slate-600 mb-4">${state.aiResults.summary}</div>
                                    <button onclick="addAiItem(${JSON.stringify(state.aiResults).replace(/"/g, '&quot;')})" class="w-full py-3 bg-orange-400 text-white rounded-xl font-bold shadow-lg flex items-center justify-center gap-2">${renderIcon('plus', 18)} åŠ å…¥æ¸…å–®</button>
                                </div>
                              ` : 
                              `<div class="flex flex-col items-center justify-center h-full text-slate-400 gap-4">
                                <div class="w-20 h-20 bg-orange-100 rounded-full flex items-center justify-center shadow-sm">${renderIcon('map-pin', 32, 'text-orange-400')}</div>
                                <p class="text-center font-medium text-sm">è¼¸å…¥é¤å»³åç¨±ï¼Œ<br/>AI å¹«ä½ åˆ†æè©•åƒ¹ï¼</p>
                              </div>`}
                         </div>
                         <div class="p-5 bg-white border-t border-orange-50 flex gap-3 flex-shrink-0">
                            <input id="restaurantInput" type="text" placeholder="è¼¸å…¥é¤å»³åç¨±..." class="flex-1 p-4 bg-slate-50 border-0 rounded-full focus:ring-4 focus:ring-orange-100 text-slate-600 font-bold outline-none">
                            <button onclick="runRestaurantSearch()" class="w-14 h-14 bg-orange-400 hover:bg-orange-500 text-white rounded-full shadow-lg flex items-center justify-center">${renderIcon('search', 24)}</button>
                         </div>
                    </div>
                </div>
                ` : ''}

                ${renderEditorModal()}
            `;

            app.innerHTML = sidebarHtml + mainHtml + modalOverlays;
            lucide.createIcons();
        }

        // --- Interaction Handlers ---
        
        window.saveApiKey = () => {
            const val = document.getElementById('apiKeyInput').value.trim();
            if (val) {
                state.apiKey = val;
                localStorage.setItem('bluebuy_apiKey', val);
                document.getElementById('apiKeyModal').classList.add('hidden');
            }
        };

        window.addFolderPrompt = () => {
            openDialog('prompt', 'æ–°å¢è³‡æ–™å¤¾', 'è«‹è¼¸å…¥è³‡æ–™å¤¾åç¨±ï¼š', (val) => {
                if(!val) return;
                const newFolder = { id: generateId(), type: 'folder', title: val, isOpen: true, children: [] };
                state.structure.push(newFolder);
                saveToStorage();
            });
        };

        window.addListPrompt = (parentId) => {
            openDialog('prompt', 'æ–°å¢æ¸…å–®', 'è«‹è¼¸å…¥æ¸…å–®åç¨±ï¼š', (val) => {
                if(!val) return;
                const newList = { id: generateId(), type: 'list', title: val, items: [], groups: [] };
                const addDeep = (nodes) => nodes.map(n => {
                    if (n.id === parentId) return { ...n, children: [...(n.children || []), newList] };
                    if (n.children) return { ...n, children: addDeep(n.children) };
                    return n;
                });
                state.structure = addDeep(state.structure);
                state.selectedListId = newList.id; // Switch to new list
                saveToStorage();
            });
        };
        
        window.addAiItem = (data) => {
            // Logic to add item from AI tool
            // Needs to select a list first if none selected, but simpler to just use current
            if (!state.selectedListId) {
                openDialog('alert', 'è«‹å…ˆé¸æ“‡æ¸…å–®', 'è«‹åœ¨èƒŒæ™¯é¸æ“‡ä¸€å€‹æ¸…å–®å¾Œå†åŠ å…¥ã€‚');
                return;
            }
            const newItem = {
                id: generateId(),
                name: data.name,
                price: 0,
                currency: 'TWD',
                note: data.summary,
                ingredients: '',
                locations: [data.address || ''],
                image: `https://loremflickr.com/300/300/${encodeURIComponent(data.image_keyword || 'food')}?random=${Date.now()}`,
                checked: false,
                groupId: null
            };
            
            const addDeep = (nodes) => nodes.map(n => {
                if (n.id === state.selectedListId) return { ...n, items: [newItem, ...n.items] };
                if (n.children) return { ...n, children: addDeep(n.children) };
                return n;
            });
            state.structure = addDeep(state.structure);
            state.modals.restaurant = false;
            state.aiResults = null;
            saveToStorage();
            openDialog('alert', 'æˆåŠŸ', `å·²åŠ å…¥ã€Œ${data.name}ã€`);
        };

        // Initialize
        if (!state.apiKey) {
            document.getElementById('apiKeyModal').classList.remove('hidden');
        }
        
        // Auto select first list if none
        if (!state.selectedListId) {
           const firstList = findList(state.structure, 'list-1'); // naive check
           if(state.structure[0]?.children?.[0]?.id) state.selectedListId = state.structure[0].children[0].id;
        }

        render();

    </script>
</body>
</html>