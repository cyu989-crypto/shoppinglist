<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BlueBuy AI Shopping List</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* 基礎設定與滾動條美化 */
        body {
            background-color: #1e293b; /* 深色背景襯托手機框 */
            font-family: system-ui, -apple-system, sans-serif;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
        }

        /* 手機外框模擬 */
        #mobile-container {
            width: 100%;
            max-width: 430px; /* 模擬 iPhone Pro Max 寬度 */
            height: 90vh;
            max-height: 932px;
            background-color: #FFF9F5;
            border-radius: 40px;
            overflow: hidden;
            position: relative;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            border: 8px solid #0f172a;
        }

        /* 自訂滾動條 */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 20px;
        }

        /* 動畫 */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }
        .loading-spin {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* 工具類 */
        .hidden { display: none !important; }
        .overlay {
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.4);
            backdrop-filter: blur(2px);
            z-index: 50;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body>

    <div id="mobile-container">
        
        <div id="api-key-modal" class="overlay" style="z-index: 100; background: rgba(0,0,0,0.8);">
            <div class="bg-white p-6 rounded-3xl w-4/5 shadow-2xl text-center">
                <div class="w-14 h-14 bg-blue-100 text-blue-500 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i data-lucide="key"></i>
                </div>
                <h2 class="text-xl font-bold text-slate-800 mb-2">請輸入 API Key</h2>
                <p class="text-sm text-slate-500 mb-4">為了使用 AI 功能，請輸入您的 Gemini API Key。</p>
                <input type="password" id="api-key-input" placeholder="貼上 API Key..." class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl mb-4 text-center focus:ring-2 focus:ring-blue-400 outline-none">
                <button onclick="App.setApiKey()" class="w-full py-3 bg-blue-500 hover:bg-blue-600 text-white rounded-xl font-bold transition-colors">開始使用</button>
            </div>
        </div>

        <aside id="sidebar" class="absolute inset-y-0 left-0 w-64 bg-white z-40 transform -translate-x-full transition-transform duration-300 shadow-xl flex flex-col">
            <div class="p-6 flex items-center gap-3 border-b border-slate-50">
                <div class="w-10 h-10 bg-blue-100 rounded-xl flex items-center justify-center text-blue-500">
                    <i data-lucide="shopping-bag"></i>
                </div>
                <h1 class="text-lg font-black text-slate-700 tracking-wider">BlueBuy</h1>
            </div>
            
            <div class="flex-1 overflow-y-auto p-4 space-y-2 custom-scrollbar" id="sidebar-content">
                </div>

            <div class="p-4 border-t border-slate-100">
                <button onclick="App.createNewList()" class="w-full py-3 border-2 border-dashed border-slate-200 text-slate-400 rounded-xl font-bold hover:border-blue-300 hover:text-blue-500 transition-colors flex items-center justify-center gap-2">
                    <i data-lucide="plus" size="16"></i> 新增清單
                </button>
            </div>
        </aside>

        <div id="sidebar-overlay" onclick="App.toggleSidebar()" class="overlay hidden" style="z-index: 30;"></div>

        <main class="flex-1 flex flex-col h-full relative w-full bg-[#FFF9F5]">
            <header class="h-20 flex items-center px-6 justify-between sticky top-0 z-20 bg-[#FFF9F5]/90 backdrop-blur-md">
                <div class="flex items-center gap-4">
                    <button onclick="App.toggleSidebar()" class="p-2 -ml-2 text-slate-400 hover:bg-white rounded-xl transition-colors">
                        <i data-lucide="menu"></i>
                    </button>
                    <div>
                        <h2 id="current-list-title" class="text-xl font-black text-slate-700 truncate max-w-[150px]">載入中...</h2>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="App.openAITools()" class="p-2.5 rounded-xl bg-white text-purple-500 shadow-sm border border-purple-100" title="AI 工具">
                        <i data-lucide="sparkles"></i>
                    </button>
                </div>
            </header>

            <div id="main-content" class="flex-1 overflow-y-auto px-6 pb-24 scroll-smooth custom-scrollbar">
                <div class="relative group mb-6 mt-2">
                    <div class="absolute inset-y-0 left-5 flex items-center pointer-events-none text-blue-300">
                        <i data-lucide="plus"></i>
                    </div>
                    <input type="text" id="new-item-input" 
                           onkeydown="if(event.key === 'Enter') App.addItem()"
                           placeholder="想要買什麼呢..." 
                           class="w-full pl-14 pr-4 py-5 bg-white rounded-[2rem] shadow-lg shadow-blue-100/50 focus:outline-none focus:ring-4 focus:ring-blue-50 transition-all text-lg placeholder:text-slate-300 text-slate-600 font-bold">
                </div>

                <div id="items-container" class="space-y-4">
                    </div>
            </div>
        </main>

        <div id="editor-modal" class="absolute inset-0 bg-[#FFF9F5] z-50 transform translate-y-full transition-transform duration-300 flex flex-col">
            <div class="p-4 border-b border-slate-100 bg-white flex justify-between items-center">
                <h3 class="font-bold text-slate-700 flex items-center gap-2">
                    <span class="bg-blue-100 p-1.5 rounded-lg text-blue-500"><i data-lucide="edit-3" size="16"></i></span> 編輯
                </h3>
                <div class="flex gap-2">
                    <button onclick="App.saveEdit()" class="bg-blue-500 text-white px-4 py-1.5 rounded-full text-sm font-bold flex items-center gap-1 shadow-md hover:bg-blue-600"><i data-lucide="check" size="14"></i> 儲存</button>
                    <button onclick="App.closeEditor()" class="p-2 text-slate-400 hover:bg-slate-50 rounded-full"><i data-lucide="x"></i></button>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto p-6 space-y-5 custom-scrollbar">
                <div class="space-y-2">
                    <label class="text-xs font-bold text-slate-400 uppercase">商品名稱</label>
                    <div class="flex gap-2">
                        <input type="text" id="edit-name" class="flex-1 p-3 bg-white border-0 rounded-xl shadow-sm font-bold text-lg outline-none">
                        <button onclick="App.smartFill()" id="btn-smart-fill" class="bg-gradient-to-br from-indigo-400 to-purple-400 text-white p-3 rounded-xl shadow-md w-14 flex items-center justify-center">
                            <i data-lucide="wand-2"></i>
                        </button>
                    </div>
                    <p class="text-xs text-purple-400 flex items-center gap-1"><i data-lucide="sparkles" size="10"></i> 點擊魔杖 AI 自動填寫</p>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div class="space-y-2">
                        <label class="text-xs font-bold text-slate-400 uppercase">價格</label>
                        <input type="number" id="edit-price" placeholder="0" class="w-full p-3 bg-white rounded-xl shadow-sm font-bold outline-none">
                    </div>
                    <div class="space-y-2">
                        <label class="text-xs font-bold text-slate-400 uppercase">幣別</label>
                        <select id="edit-currency" class="w-full p-3 bg-white rounded-xl shadow-sm outline-none font-medium text-slate-600">
                            <option value="TWD">TWD</option>
                            <option value="JPY">JPY</option>
                            <option value="USD">USD</option>
                        </select>
                    </div>
                </div>

                <div class="space-y-2">
                    <label class="text-xs font-bold text-amber-500 uppercase flex items-center gap-1"><i data-lucide="utensils" size="12"></i> 成分/備註</label>
                    <textarea id="edit-ingredients" rows="3" class="w-full p-3 bg-amber-50 border-0 rounded-xl resize-none text-slate-600 text-sm leading-relaxed outline-none" placeholder="AI 會自動填寫成分..."></textarea>
                </div>

                <div class="space-y-2">
                    <label class="text-xs font-bold text-emerald-500 uppercase flex items-center gap-1"><i data-lucide="map-pin" size="12"></i> 購買地點</label>
                    <div class="flex gap-2 mb-2">
                        <input type="text" id="new-loc-input" placeholder="新增地點..." class="flex-1 p-2 bg-emerald-50 rounded-lg text-sm outline-none">
                        <button onclick="App.addLocation()" class="bg-emerald-100 text-emerald-600 p-2 rounded-lg"><i data-lucide="plus" size="16"></i></button>
                    </div>
                    <div id="edit-locations" class="flex flex-wrap gap-2"></div>
                </div>
                
                <div class="pt-4 border-t border-slate-100">
                     <button onclick="App.deleteItem()" class="w-full py-3 text-rose-400 bg-rose-50 rounded-xl font-bold text-sm hover:bg-rose-100">刪除此商品</button>
                </div>
            </div>
        </div>

        <div id="ai-tools-modal" class="overlay hidden" onclick="if(event.target === this) App.closeAITools()">
            <div class="bg-white rounded-3xl w-4/5 p-6 animate-fade-in shadow-2xl">
                <h3 class="font-bold text-slate-700 text-lg mb-4 text-center">AI 智慧助手</h3>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="App.openTool('restaurant')" class="flex flex-col items-center justify-center gap-2 bg-orange-50 text-orange-500 py-4 rounded-2xl hover:bg-orange-100 transition-colors">
                        <i data-lucide="utensils"></i> <span class="text-xs font-bold">餐廳探查</span>
                    </button>
                    <button onclick="App.openTool('hotel')" class="flex flex-col items-center justify-center gap-2 bg-purple-50 text-purple-500 py-4 rounded-2xl hover:bg-purple-100 transition-colors">
                        <i data-lucide="bed"></i> <span class="text-xs font-bold">飯店分析</span>
                    </button>
                    <button onclick="App.openTool('advisor')" class="col-span-2 flex flex-col items-center justify-center gap-2 bg-blue-50 text-blue-500 py-4 rounded-2xl hover:bg-blue-100 transition-colors">
                        <i data-lucide="lightbulb"></i> <span class="text-xs font-bold">購物顧問 (不知道買什麼?)</span>
                    </button>
                </div>
                <button onclick="App.closeAITools()" class="w-full mt-4 py-3 text-slate-400 font-bold text-sm">取消</button>
            </div>
        </div>

        <div id="query-modal" class="absolute inset-0 bg-[#FFF9F5] z-50 transform translate-y-full transition-transform duration-300 flex flex-col">
             <div class="p-4 bg-white border-b border-slate-100 flex justify-between items-center">
                 <h3 id="query-title" class="font-bold text-slate-700 flex items-center gap-2">AI 查詢</h3>
                 <button onclick="App.closeQuery()" class="p-2 text-slate-400 bg-slate-50 rounded-full"><i data-lucide="x"></i></button>
             </div>
             <div id="query-result" class="flex-1 overflow-y-auto p-4 custom-scrollbar">
                 <div class="flex flex-col items-center justify-center h-full text-slate-400 gap-4 opacity-50">
                     <i id="query-icon" data-lucide="search" size="48"></i>
                     <p>請在下方輸入關鍵字...</p>
                 </div>
             </div>
             <div class="p-4 bg-white border-t border-slate-100 flex gap-2">
                 <input type="text" id="query-input" placeholder="輸入名稱..." class="flex-1 p-3 bg-slate-50 rounded-full outline-none font-bold text-slate-600">
                 <button onclick="App.runQuery()" id="btn-run-query" class="w-12 h-12 bg-blue-400 text-white rounded-full flex items-center justify-center shadow-lg hover:bg-blue-500">
                     <i data-lucide="arrow-right"></i>
                 </button>
             </div>
        </div>

    </div>

    <script>
        // --- 應用程式核心邏輯 ---
        const App = {
            state: {
                apiKey: '',
                lists: [],
                activeListId: null,
                editingItem: null,
                tempLocations: [],
                currentTool: null // 'restaurant', 'hotel', 'advisor'
            },
            
            // 初始化
            init() {
                // 嘗試從 LocalStorage 讀取資料
                const savedData = localStorage.getItem('bluebuy_data');
                if (savedData) {
                    this.state.lists = JSON.parse(savedData);
                } else {
                    // 預設資料
                    this.state.lists = [{ 
                        id: 'default', title: '我的購物清單', 
                        items: [
                            { id: '1', name: '牛奶', price: 95, currency: 'TWD', ingredients: '', locations: ['7-11'], checked: false },
                            { id: '2', name: '雞蛋', price: 120, currency: 'TWD', ingredients: '', locations: ['全聯'], checked: false }
                        ] 
                    }];
                }
                
                // 設定預設清單
                this.state.activeListId = this.state.lists[0]?.id || null;
                
                this.renderSidebar();
                this.renderMain();
                lucide.createIcons();
            },

            // --- 介面操作 ---
            setApiKey() {
                const input = document.getElementById('api-key-input').value.trim();
                if (!input) return alert('請輸入 API Key');
                this.state.apiKey = input;
                document.getElementById('api-key-modal').classList.add('hidden');
            },

            toggleSidebar() {
                const sidebar = document.getElementById('sidebar');
                const overlay = document.getElementById('sidebar-overlay');
                if (sidebar.classList.contains('-translate-x-full')) {
                    sidebar.classList.remove('-translate-x-full');
                    overlay.classList.remove('hidden');
                } else {
                    sidebar.classList.add('-translate-x-full');
                    overlay.classList.add('hidden');
                }
            },

            switchList(id) {
                this.state.activeListId = id;
                this.toggleSidebar();
                this.renderMain();
                this.renderSidebar(); // 更新選取狀態
            },

            createNewList() {
                const name = prompt('請輸入新清單名稱：', '新清單');
                if (name) {
                    const newList = { id: Date.now().toString(), title: name, items: [] };
                    this.state.lists.push(newList);
                    this.saveData();
                    this.switchList(newList.id);
                }
            },

            // --- 項目 CRUD ---
            addItem() {
                const input = document.getElementById('new-item-input');
                const name = input.value.trim();
                if (!name) return;
                
                const list = this.state.lists.find(l => l.id === this.state.activeListId);
                if (list) {
                    list.items.unshift({
                        id: Date.now().toString(),
                        name: name,
                        price: 0,
                        currency: 'TWD',
                        ingredients: '',
                        locations: [],
                        checked: false
                    });
                    this.saveData();
                    this.renderMain();
                    input.value = '';
                }
            },

            toggleCheck(itemId) {
                const list = this.state.lists.find(l => l.id === this.state.activeListId);
                const item = list.items.find(i => i.id === itemId);
                if (item) {
                    item.checked = !item.checked;
                    this.saveData();
                    this.renderMain();
                }
            },

            openEditor(itemId) {
                const list = this.state.lists.find(l => l.id === this.state.activeListId);
                const item = list.items.find(i => i.id === itemId);
                if (!item) return;

                this.state.editingItem = item;
                this.state.tempLocations = [...(item.locations || [])];

                // 填入資料
                document.getElementById('edit-name').value = item.name;
                document.getElementById('edit-price').value = item.price || '';
                document.getElementById('edit-currency').value = item.currency || 'TWD';
                document.getElementById('edit-ingredients').value = item.ingredients || '';
                this.renderEditLocations();

                document.getElementById('editor-modal').classList.remove('translate-y-full');
            },

            closeEditor() {
                document.getElementById('editor-modal').classList.add('translate-y-full');
                this.state.editingItem = null;
            },

            saveEdit() {
                if (!this.state.editingItem) return;
                const item = this.state.editingItem;
                item.name = document.getElementById('edit-name').value;
                item.price = Number(document.getElementById('edit-price').value) || 0;
                item.currency = document.getElementById('edit-currency').value;
                item.ingredients = document.getElementById('edit-ingredients').value;
                item.locations = [...this.state.tempLocations];

                this.saveData();
                this.renderMain();
                this.closeEditor();
            },

            deleteItem() {
                if (!this.state.editingItem || !confirm('確定要刪除嗎？')) return;
                const list = this.state.lists.find(l => l.id === this.state.activeListId);
                list.items = list.items.filter(i => i.id !== this.state.editingItem.id);
                this.saveData();
                this.renderMain();
                this.closeEditor();
            },

            addLocation() {
                const input = document.getElementById('new-loc-input');
                const val = input.value.trim();
                if (val) {
                    this.state.tempLocations.push(val);
                    input.value = '';
                    this.renderEditLocations();
                }
            },

            removeLocation(idx) {
                this.state.tempLocations.splice(idx, 1);
                this.renderEditLocations();
            },

            // --- 渲染函數 ---
            renderSidebar() {
                const container = document.getElementById('sidebar-content');
                container.innerHTML = this.state.lists.map(list => `
                    <button onclick="App.switchList('${list.id}')" class="w-full text-left p-3 rounded-xl flex items-center justify-between group transition-colors ${list.id === this.state.activeListId ? 'bg-blue-50 text-blue-500 font-bold' : 'text-slate-500 hover:bg-slate-50'}">
                        <span class="truncate">${list.title}</span>
                        <span class="text-xs bg-white px-2 py-1 rounded-full shadow-sm text-slate-400">${list.items.length}</span>
                    </button>
                `).join('');
            },

            renderMain() {
                const list = this.state.lists.find(l => l.id === this.state.activeListId);
                if (!list) return;

                document.getElementById('current-list-title').innerText = list.title;
                const container = document.getElementById('items-container');
                
                if (list.items.length === 0) {
                    container.innerHTML = `<div class="text-center py-20 text-slate-300">清單空空的，加點東西吧！</div>`;
                } else {
                    container.innerHTML = list.items.map(item => `
                        <div onclick="App.openEditor('${item.id}')" class="bg-white p-4 rounded-[24px] shadow-sm flex items-start gap-3 border border-slate-100 transition-all active:scale-[0.98]">
                            <button onclick="event.stopPropagation(); App.toggleCheck('${item.id}')" class="mt-1 w-6 h-6 rounded-full border-2 flex items-center justify-center flex-shrink-0 transition-colors ${item.checked ? 'bg-blue-400 border-blue-400 text-white' : 'border-slate-200 text-transparent'}">
                                <i data-lucide="check" width="14"></i>
                            </button>
                            <div class="flex-1 min-w-0 ${item.checked ? 'opacity-50 grayscale' : ''}">
                                <div class="flex justify-between items-start">
                                    <h3 class="font-bold text-slate-700 text-lg leading-tight ${item.checked ? 'line-through text-slate-400' : ''}">${item.name}</h3>
                                    ${item.price > 0 ? `<span class="bg-blue-50 text-blue-500 text-xs font-bold px-2 py-1 rounded-lg">${item.currency === 'JPY' ? '¥' : '$'}${item.price}</span>` : ''}
                                </div>
                                ${(item.locations && item.locations.length > 0) ? `
                                    <div class="flex flex-wrap gap-1 mt-2">
                                        ${item.locations.map(loc => `<span class="text-[10px] bg-emerald-50 text-emerald-600 px-2 py-0.5 rounded-md font-bold">${loc}</span>`).join('')}
                                    </div>
                                ` : ''}
                                ${item.ingredients ? `<p class="text-xs text-slate-400 mt-1 truncate">${item.ingredients}</p>` : ''}
                            </div>
                        </div>
                    `).join('');
                }
                lucide.createIcons();
            },

            renderEditLocations() {
                const container = document.getElementById('edit-locations');
                container.innerHTML = this.state.tempLocations.map((loc, idx) => `
                    <span class="bg-emerald-50 text-emerald-600 px-2 py-1 rounded-lg text-xs font-bold flex items-center gap-1">
                        ${loc} <button onclick="App.removeLocation(${idx})" class="hover:text-red-500"><i data-lucide="x" width="10"></i></button>
                    </span>
                `).join('');
                lucide.createIcons();
            },

            saveData() {
                localStorage.setItem('bluebuy_data', JSON.stringify(this.state.lists));
            },

            // --- AI 核心邏輯 (Gemini) ---
            async callGemini(prompt, schema = null) {
                if (!this.state.apiKey) {
                    alert('請先輸入 API Key');
                    document.getElementById('api-key-modal').classList.remove('hidden');
                    return null;
                }

                const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: { responseMimeType: "application/json" }
                };
                if (schema) payload.generationConfig.responseSchema = schema;
                
                // 模擬搜尋工具開啟 (雖然這裡只用純模型，但為了符合 prompt 請求，使用模型內建知識)
                try {
                    const response = await fetch(
                        `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${this.state.apiKey}`,
                        {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        }
                    );

                    if (!response.ok) throw new Error(`API Error: ${response.status}`);
                    const data = await response.json();
                    const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (!text) throw new Error("Empty response");

                    // 清理並解析 JSON
                    let cleanText = text.replace(/```json/g, '').replace(/```/g, '').trim();
                    const start = cleanText.indexOf('{');
                    const end = cleanText.lastIndexOf('}');
                    if (start !== -1 && end !== -1) cleanText = cleanText.substring(start, end + 1);
                    return JSON.parse(cleanText);

                } catch (error) {
                    console.error(error);
                    alert("AI 呼叫失敗，請檢查 API Key 或網路連線。");
                    return null;
                }
            },

            // 1. 智慧填寫
            async smartFill() {
                const name = document.getElementById('edit-name').value;
                if (!name) return;
                
                const btn = document.getElementById('btn-smart-fill');
                const originalHtml = btn.innerHTML;
                btn.innerHTML = `<div class="loading-spin"><i data-lucide="loader-2"></i></div>`;
                lucide.createIcons();

                const currency = document.getElementById('edit-currency').value;
                const prompt = `
                    Product: "${name}". Target Currency: ${currency}.
                    Task: 
                    1. Estimate price (number only).
                    2. List 3 common ingredients/features in Traditional Chinese.
                    3. List 2 common store types in Taiwan/Japan (based on currency).
                    Return JSON: { "price": number, "ingredients": string, "locations": string[] }
                `;

                const result = await this.callGemini(prompt);
                if (result) {
                    document.getElementById('edit-price').value = result.price;
                    document.getElementById('edit-ingredients').value = result.ingredients;
                    this.state.tempLocations = result.locations || [];
                    this.renderEditLocations();
                }

                btn.innerHTML = originalHtml;
                lucide.createIcons();
            },

            // 2. AI 工具介面控制
            openAITools() { document.getElementById('ai-tools-modal').classList.remove('hidden'); },
            closeAITools() { document.getElementById('ai-tools-modal').classList.add('hidden'); },
            
            openTool(tool) {
                this.state.currentTool = tool;
                this.closeAITools();
                
                const modal = document.getElementById('query-modal');
                const titleEl = document.getElementById('query-title');
                const iconEl = document.getElementById('query-icon');
                const inputEl = document.getElementById('query-input');
                const resultEl = document.getElementById('query-result');

                resultEl.innerHTML = `<div class="flex flex-col items-center justify-center h-full text-slate-400 gap-4 opacity-50"><i data-lucide="search" size="48"></i><p>請輸入關鍵字...</p></div>`;
                inputEl.value = '';

                if (tool === 'restaurant') {
                    titleEl.innerText = "餐廳探查";
                    iconEl.setAttribute('data-lucide', 'utensils');
                    inputEl.placeholder = "輸入餐廳名稱...";
                } else if (tool === 'hotel') {
                    titleEl.innerText = "飯店分析";
                    iconEl.setAttribute('data-lucide', 'bed');
                    inputEl.placeholder = "輸入飯店名稱...";
                } else {
                    titleEl.innerText = "購物顧問";
                    iconEl.setAttribute('data-lucide', 'lightbulb');
                    inputEl.placeholder = "輸入你的需求 (例如: 日本感冒藥)...";
                }
                
                lucide.createIcons();
                modal.classList.remove('translate-y-full');
            },

            closeQuery() {
                document.getElementById('query-modal').classList.add('translate-y-full');
            },

            // 3. 執行查詢
            async runQuery() {
                const query = document.getElementById('query-input').value;
                if (!query) return;

                const btn = document.getElementById('btn-run-query');
                const originalHtml = btn.innerHTML;
                btn.innerHTML = `<div class="loading-spin"><i data-lucide="loader-2"></i></div>`;
                lucide.createIcons();

                const container = document.getElementById('query-result');
                const tool = this.state.currentTool;
                let prompt = '';

                if (tool === 'restaurant') {
                    prompt = `Analysis restaurant: "${query}". Return JSON: {"name": "Name", "rating": 4.5, "summary": "Pros/Cons summary in Traditional Chinese", "dishes": ["Dish 1", "Dish 2"]}`;
                } else if (tool === 'hotel') {
                    prompt = `Analyze hotel: "${query}". Return JSON: {"name": "Name", "rating": 4.5, "price_range": "e.g. 3000-5000 TWD", "summary": "Review summary in Traditional Chinese", "amenities": ["Wifi", "Pool"]}`;
                } else {
                    prompt = `Shopping Advisor: "${query}". Return JSON: {"recommendations": [{"name": "Item Name", "reason": "Why", "price": 100, "currency": "TWD"}]}`;
                }

                const result = await this.callGemini(prompt);
                
                if (result) {
                    let html = '';
                    if (tool === 'restaurant') {
                        html = `
                            <div class="bg-white p-5 rounded-3xl shadow-sm border border-orange-100">
                                <h2 class="text-xl font-bold text-slate-800 flex justify-between">${result.name} <span class="bg-orange-100 text-orange-600 text-xs px-2 py-1 rounded-full">${result.rating}★</span></h2>
                                <p class="text-sm text-slate-600 my-3 bg-slate-50 p-3 rounded-xl">${result.summary}</p>
                                <h4 class="font-bold text-sm text-slate-500 mb-2">推薦菜色:</h4>
                                <div class="flex flex-wrap gap-2 mb-4">
                                    ${result.dishes.map(d => `<span class="bg-orange-50 text-orange-500 px-2 py-1 rounded-lg text-xs font-bold">${d}</span>`).join('')}
                                </div>
                                <button onclick="App.addFromAI('${result.name}', '餐廳: ${result.name}', 0)" class="w-full py-3 bg-orange-400 text-white rounded-xl font-bold shadow-lg">加入清單</button>
                            </div>
                        `;
                    } else if (tool === 'hotel') {
                        html = `
                             <div class="bg-white p-5 rounded-3xl shadow-sm border border-purple-100">
                                <h2 class="text-xl font-bold text-slate-800 flex justify-between">${result.name} <span class="bg-purple-100 text-purple-600 text-xs px-2 py-1 rounded-full">${result.rating}★</span></h2>
                                <div class="text-sm font-bold text-slate-500 mb-2">${result.price_range}</div>
                                <p class="text-sm text-slate-600 my-3 bg-slate-50 p-3 rounded-xl">${result.summary}</p>
                                <div class="flex flex-wrap gap-2 mb-4">
                                    ${(result.amenities || []).map(a => `<span class="bg-purple-50 text-purple-500 px-2 py-1 rounded-lg text-xs font-bold">${a}</span>`).join('')}
                                </div>
                                <button onclick="App.addFromAI('${result.name}', '飯店: ${result.price_range}', 0)" class="w-full py-3 bg-purple-400 text-white rounded-xl font-bold shadow-lg">加入清單</button>
                            </div>
                        `;
                    } else {
                        html = `<div class="space-y-3">
                            ${result.recommendations.map(item => `
                                <div class="bg-white p-4 rounded-2xl shadow-sm border border-blue-50">
                                    <div class="flex justify-between font-bold text-slate-700">
                                        ${item.name} <span class="text-blue-500">${item.currency} ${item.price}</span>
                                    </div>
                                    <p class="text-xs text-slate-500 my-2">${item.reason}</p>
                                    <button onclick="App.addFromAI('${item.name}', '${item.reason}', ${item.price})" class="text-xs bg-blue-50 text-blue-500 px-3 py-1.5 rounded-full font-bold">+ 加入</button>
                                </div>
                            `).join('')}
                        </div>`;
                    }
                    container.innerHTML = html;
                }

                btn.innerHTML = originalHtml;
                lucide.createIcons();
            },

            addFromAI(name, note, price) {
                const list = this.state.lists.find(l => l.id === this.state.activeListId);
                if (list) {
                    list.items.unshift({
                        id: Date.now().toString(),
                        name: name,
                        price: price,
                        currency: 'TWD',
                        ingredients: note,
                        locations: [],
                        checked: false
                    });
                    this.saveData();
                    this.renderMain();
                    alert(`已加入「${name}」！`);
                    this.closeQuery();
                }
            }
        };

        // 啟動應用
        window.addEventListener('DOMContentLoaded', () => {
            App.init();
        });

    </script>
</body>
</html>