<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>BlueBuy - AI è³¼ç‰©æ¸…å–®</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/lucide@latest"></script>

    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #FFF9F5;
            overflow: hidden; /* é˜²æ­¢æ•´å€‹é é¢æ»¾å‹• */
            -webkit-tap-highlight-color: transparent;
        }
        
        /* é‡å° iOS Safe Area çš„èª¿æ•´ */
        .pb-safe {
            padding-bottom: env(safe-area-inset-bottom, 20px);
        }

        /* è‡ªå®šç¾©æ»¾å‹•æ¢ */
        .custom-scrollbar::-webkit-scrollbar { width: 4px; height: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        
        input[type="checkbox"] { accent-color: #3b82f6; width: 1.2rem; height: 1.2rem; }
    </style>
</head>
<body class="text-slate-600 selection:bg-blue-100 h-[100dvh] w-full flex">

    <div id="app" class="flex w-full h-full relative overflow-hidden">
        <div id="loading-screen" class="flex h-full w-full items-center justify-center flex-col gap-6 absolute inset-0 bg-[#FFF9F5] z-50">
            <div class="w-20 h-20 bg-white rounded-full shadow-xl flex items-center justify-center animate-bounce text-blue-300">
                <i data-lucide="shopping-bag" width="40" height="40"></i>
            </div>
            <p class="text-slate-400 font-bold tracking-[0.2em] animate-pulse text-sm">LOADING...</p>
        </div>
    </div>

    <div id="modal-overlay"></div>
    <div id="dialog-overlay"></div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged, signInAnonymously } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // --- Config ---
        const firebaseConfig = {
            apiKey: "YOUR_FIREBASE_API_KEY", 
            authDomain: "YOUR_PROJECT.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        const APP_ID = 'default-app-id';

        let app, auth, db;
        try {
            if (firebaseConfig.apiKey !== "YOUR_FIREBASE_API_KEY") {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
            } else {
                console.warn("ä½¿ç”¨æœ¬åœ° Mock æ¨¡å¼ (æœªè¨­å®š Firebase)");
            }
        } catch (e) { console.error("Firebase Init Error:", e); }

        // --- State ---
        const initialState = {
            user: null,
            structure: [],
            isLoaded: false,
            isSaving: false,
            selectedListId: null,
            isSidebarOpen: false, 
            sidebarTab: 'lists',
            viewMode: 'list',
            newItemName: '',
            editingItem: null,
            pendingItemToAdd: null,
            moveTarget: null 
        };
        let state = { ...initialState };

        const mockStructure = [{
            id: 'folder-1', type: 'folder', title: 'ä¾¿åˆ©å•†åº— ğŸª', isOpen: true,
            children: [{
                id: 'list-1', type: 'list', title: '7-ELEVEN',
                groups: [{ id: 'group-1', title: 'é£²æ–™ Drinks', isOpen: true }],
                items: [{ id: 'item-1', name: 'å¾¡é£¯ç³°', price: 35, currency: 'TWD', note: 'é®ªé­šå£å‘³', ingredients: 'ç™½ç±³ã€é®ªé­š', locations: ['7-ELEVEN'], checked: false, groupId: null }]
            }]
        }];

        // --- Helpers ---
        const generateId = () => Math.random().toString(36).substr(2, 9);
        const refreshIcons = () => { if (window.lucide) window.lucide.createIcons(); };
        const iconHTML = (name, size=16, classes="") => `<i data-lucide="${name}" width="${size}" height="${size}" class="${classes}"></i>`;
        
        const getAllergens = (text) => {
            if (!text) return [];
            const features = [];
            if (text.match(/è¾£|æ¤’|è¾›|éº»è¾£/)) features.push({ emoji: 'ğŸŒ¶ï¸', color: 'text-rose-500', bg: 'bg-rose-50', label: 'è¾›è¾£' });
            if (text.match(/å¥¶|ä¹³|èµ·å¸|å¥¶æ²¹/)) features.push({ emoji: 'ğŸ¥›', color: 'text-sky-500', bg: 'bg-sky-50', label: 'ä¹³è£½å“' });
            if (text.match(/è¦|èŸ¹|è²|é­š|æµ·é®®/)) features.push({ emoji: 'ğŸ¦', color: 'text-indigo-500', bg: 'bg-indigo-50', label: 'æµ·é®®' });
            if (text.match(/èŠ±ç”Ÿ|å …æœ/)) features.push({ emoji: 'ğŸ¥œ', color: 'text-amber-600', bg: 'bg-amber-50', label: 'å …æœ' });
            return features;
        };

        // --- API Key Modal ---
        const showApiKeyModal = () => {
            const overlay = document.getElementById('modal-overlay');
            const currentKey = localStorage.getItem('gemini_api_key') || '';
            
            overlay.innerHTML = `
            <div class="fixed inset-0 bg-black/50 z-[80] flex items-center justify-center p-4 animate-fade-in">
                <div class="bg-white rounded-[2rem] shadow-2xl w-full max-w-md p-6 border-4 border-white/50">
                    <div class="flex flex-col items-center text-center gap-3 mb-5">
                        <div class="w-14 h-14 bg-indigo-100 text-indigo-500 rounded-full flex items-center justify-center">${iconHTML('key', 28)}</div>
                        <h3 class="text-lg font-bold text-slate-700">è¨­å®š Gemini API Key</h3>
                    </div>
                    <p class="text-slate-500 mb-4 text-center text-sm">è«‹è¼¸å…¥ API Key ä»¥å•Ÿç”¨ AI åŠŸèƒ½ã€‚<br><span class="text-xs text-slate-400">(å„²å­˜æ–¼æœ¬åœ°ç€è¦½å™¨ï¼Œä¸æœƒä¸Šå‚³ä¼ºæœå™¨)</span></p>
                    <input type="password" id="input-api-key" value="${currentKey}" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl mb-6 focus:ring-2 focus:ring-indigo-400 text-slate-700 outline-none font-bold text-center text-lg" placeholder="AIzaSy...">
                    <div class="flex justify-center gap-3">
                        <button id="modal-close-key" class="flex-1 py-4 text-slate-500 hover:bg-slate-100 rounded-2xl font-bold transition-colors text-base">å–æ¶ˆ</button>
                        <button id="modal-save-key" class="flex-1 py-4 bg-indigo-500 hover:bg-indigo-600 text-white rounded-2xl font-bold shadow-md transition-colors text-base">å„²å­˜</button>
                    </div>
                </div>
            </div>`;
            refreshIcons();

            document.getElementById('modal-close-key').onclick = () => overlay.innerHTML = '';
            document.getElementById('modal-save-key').onclick = () => {
                const val = document.getElementById('input-api-key').value.trim();
                if (val) {
                    localStorage.setItem('gemini_api_key', val);
                    alert("API Key å·²å„²å­˜ï¼");
                    overlay.innerHTML = '';
                } else alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„ API Key");
            };
        };

        // --- API Helper ---
        const callGemini = async (prompt, schema = null, useSearch = false) => {
            const apiKey = localStorage.getItem('gemini_api_key');
            if (!apiKey) {
                showApiKeyModal();
                throw new Error("Missing API Key");
            }
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: { responseMimeType: "application/json" }
            };
            if (schema) payload.generationConfig.responseSchema = schema;
            if (useSearch) payload.tools = [{ google_search: {} }];

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${apiKey}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    if (response.status === 400 || response.status === 403) { alert("API Key ç„¡æ•ˆæˆ–å·²éæœŸ"); showApiKeyModal(); }
                    throw new Error(`API Error: ${response.status}`);
                }
                const data = await response.json();
                let text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!text) throw new Error("Empty response");
                text = text.replace(/```json/g, '').replace(/```/g, '').trim();
                const start = text.indexOf('{'), end = text.lastIndexOf('}');
                return JSON.parse((start !== -1 && end !== -1) ? text.substring(start, end + 1) : text);
            } catch (error) { console.error("API Error", error); throw error; }
        };

        // --- Render Functions (Mobile Optimized) ---
        
        const renderSidebarNode = (node, level = 0) => {
            const isSelected = node.id === state.selectedListId;
            const paddingLeft = level * 16 + 24;
            
            if (node.type === 'folder') {
                return `
                <div class="my-1 select-none">
                    <div class="group flex items-center justify-between py-4 pr-4 cursor-pointer text-slate-600 transition-all mr-2 rounded-r-full hover:bg-blue-50 active:bg-blue-100" style="padding-left: ${paddingLeft}px" data-action="toggle-folder" data-id="${node.id}">
                        <div class="flex items-center gap-3 font-bold tracking-wide overflow-hidden pointer-events-none">
                            ${node.isOpen ? iconHTML('chevron-down', 20, 'text-blue-400') : iconHTML('chevron-right', 20, 'text-slate-400')}
                            ${iconHTML('folder', 20, 'text-blue-400 fill-blue-50')}
                            <span class="truncate text-base">${node.title}</span>
                        </div>
                        <div class="flex gap-2 opacity-100 md:opacity-0 md:group-hover:opacity-100 transition-opacity">
                            <button data-action="rename-node" data-id="${node.id}" data-title="${node.title}" class="p-2 text-slate-400 hover:text-blue-500 bg-white rounded-full shadow-sm border border-slate-100">${iconHTML('pencil', 16)}</button>
                            <button data-action="add-list-to-folder" data-id="${node.id}" class="p-2 text-blue-400 hover:text-blue-600 bg-white rounded-full shadow-sm border border-slate-100">${iconHTML('plus', 16)}</button>
                            <button data-action="delete-node" data-id="${node.id}" class="p-2 text-rose-400 hover:text-rose-600 bg-white rounded-full shadow-sm border border-slate-100">${iconHTML('trash-2', 16)}</button>
                        </div>
                    </div>
                    ${node.isOpen && node.children ? `<div class="relative"><div class="absolute left-[33px] top-0 bottom-4 w-0.5 border-l-2 border-dotted border-blue-200 ml-4"></div>${node.children.map(c => renderSidebarNode(c, level + 1)).join('')}</div>` : ''}
                </div>`;
            } else {
                return `
                <div class="my-1 select-none">
                    <div class="${isSelected ? 'bg-blue-100 text-blue-600 font-bold' : 'text-slate-500 hover:bg-slate-100 active:bg-slate-200'} group flex items-center justify-between py-4 pr-4 cursor-pointer transition-all mr-2 rounded-r-full" style="padding-left: ${paddingLeft}px" data-action="select-list" data-id="${node.id}">
                        <div class="flex items-center gap-3 overflow-hidden pointer-events-none">
                            <div class="w-2.5 h-2.5 rounded-full flex-shrink-0 ${isSelected ? 'bg-blue-500' : 'bg-slate-300'}"></div>
                            <span class="truncate tracking-wide text-base">${node.title}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="${isSelected ? 'bg-white text-blue-500' : 'bg-slate-200 text-slate-500'} text-xs px-2.5 py-1 rounded-full font-bold">${node.items?.length || 0}</span>
                            <div class="flex gap-2 opacity-100 md:opacity-0 group-hover:opacity-100 transition-opacity">
                                <button data-action="move-list" data-id="${node.id}" class="p-2 text-slate-400 hover:text-blue-500 bg-white rounded-full shadow-sm" title="ç§»å‹•">${iconHTML('folder-input', 16)}</button>
                                <button data-action="rename-node" data-id="${node.id}" data-title="${node.title}" class="p-2 text-slate-400 hover:text-blue-500 bg-white rounded-full shadow-sm">${iconHTML('pencil', 16)}</button>
                                <button data-action="delete-node" data-id="${node.id}" class="p-2 text-slate-400 hover:text-rose-500 bg-white rounded-full shadow-sm">${iconHTML('trash-2', 16)}</button>
                            </div>
                        </div>
                    </div>
                </div>`;
            }
        };

        const renderItemCard = (item) => {
            const isGrid = state.viewMode === 'grid';
            const tags = getAllergens(`${item.name} ${item.ingredients || ''}`);
            const tagsHTML = tags.map(tag => `<div class="flex items-center gap-1 text-[11px] font-bold px-2 py-1 rounded-lg ${tag.bg} ${tag.color}"><span>${tag.emoji}</span>${tag.label}</div>`).join('');
            const locHTML = (item.locations || []).map(l => `<span class="bg-emerald-50 text-emerald-600 text-[11px] px-2 py-1 rounded border border-emerald-100 flex items-center gap-1">${iconHTML('map-pin', 12)} ${l}</span>`).join('');
            const imgHTML = item.image ? `<img src="${item.image}" class="w-full h-full object-cover block" loading="lazy">` : `<div class="w-full h-full flex items-center justify-center text-slate-300">${iconHTML('image', 24)}</div>`;

            if (isGrid) {
                return `
                <div class="group relative bg-white rounded-[24px] border border-slate-100 p-4 shadow-sm hover:shadow-lg transition-all flex flex-col h-full ${item.checked ? 'opacity-60 grayscale' : ''}" data-id="${item.id}">
                    <div class="relative w-full aspect-video bg-slate-50 rounded-2xl overflow-hidden mb-3 border-2 border-white shadow-sm cursor-pointer" data-action="edit-item" data-id="${item.id}">${imgHTML}</div>
                    <button class="absolute top-6 right-6 w-10 h-10 rounded-full border-[3px] flex items-center justify-center bg-white shadow-md ${item.checked ? 'border-blue-300 text-blue-400' : 'border-slate-200 text-slate-200'}" data-action="toggle-check" data-id="${item.id}">${iconHTML('check', 20, 'stroke-[4px]')}</button>
                    <div class="flex-1 cursor-pointer" data-action="edit-item" data-id="${item.id}">
                        <div class="flex justify-between items-start gap-2 mb-2"><h3 class="font-bold text-lg leading-snug break-words tracking-wide ${item.checked ? 'line-through text-slate-400' : 'text-slate-700'}">${item.name}</h3>${item.price > 0 ? `<div class="font-bold text-blue-500 bg-blue-50 px-2 py-1 rounded-xl text-sm whitespace-nowrap">${item.currency==='JPY'?'Â¥':'$'}${item.price}</div>`:''}</div>
                        <div class="flex flex-wrap gap-1.5 mb-2">${tagsHTML}</div>
                        ${item.note ? `<p class="text-sm text-slate-500 bg-slate-50 px-2.5 py-1.5 rounded-lg line-clamp-2">${item.note}</p>` : ''}
                    </div>
                </div>`;
            }
            return `
            <div class="group relative bg-white rounded-[24px] border border-slate-100 p-4 md:p-5 shadow-sm hover:shadow-lg transition-all ${item.checked ? 'opacity-60 grayscale bg-slate-50' : ''}" data-id="${item.id}">
                <div class="flex gap-4 items-start relative">
                    <button class="flex-shrink-0 w-8 h-8 md:w-8 md:h-8 rounded-full border-[3px] flex items-center justify-center transition-all mt-1 ${item.checked ? 'bg-blue-300 border-blue-300 text-white' : 'border-slate-200 text-transparent hover:border-blue-300'}" data-action="toggle-check" data-id="${item.id}">${iconHTML('check', 16, 'stroke-[4px]')}</button>
                    <div class="w-20 h-20 md:w-16 md:h-16 bg-slate-50 rounded-2xl overflow-hidden flex-shrink-0 border-2 border-white shadow-sm mt-0.5 cursor-pointer" data-action="edit-item" data-id="${item.id}">${imgHTML}</div>
                    <div class="flex-1 min-w-0 cursor-pointer py-0.5" data-action="edit-item" data-id="${item.id}">
                        <div class="flex justify-between items-start gap-2"><h3 class="font-bold text-lg md:text-base leading-snug break-words tracking-wide ${item.checked ? 'line-through text-slate-400' : 'text-slate-700'}">${item.name}</h3>${item.price > 0 ? `<div class="font-bold text-blue-500 bg-blue-50 px-3 py-1.5 rounded-2xl text-xs whitespace-nowrap">${item.currency==='JPY'?'Â¥':'$'}${item.price}</div>`:''}</div>
                        <div class="flex flex-wrap gap-1.5 mt-2">${tagsHTML}</div>
                        ${item.note ? `<div class="mt-2 text-sm text-slate-500 bg-slate-50 px-2.5 py-1 rounded-xl font-medium inline-block">${item.note}</div>` : ''}
                        <div class="flex flex-wrap gap-2 mt-2">${locHTML}</div>
                    </div>
                    <div class="flex flex-col gap-2 md:opacity-0 group-hover:opacity-100 transition-opacity absolute right-0 bottom-0 md:static md:flex-row md:self-center">
                         <button data-action="move-item" data-id="${item.id}" class="p-2 text-slate-400 hover:text-blue-500 bg-white rounded-full shadow-sm border border-slate-100 md:border-0" title="ç§»å‹•">${iconHTML('arrow-right-circle', 18)}</button>
                        <button data-action="edit-item" data-id="${item.id}" class="p-2 text-slate-400 hover:text-blue-500 bg-white rounded-full shadow-sm border border-slate-100 md:border-0">${iconHTML('edit-3', 18)}</button>
                        <button data-action="delete-item" data-id="${item.id}" class="p-2 text-slate-400 hover:text-rose-400 bg-white rounded-full shadow-sm border border-slate-100 md:border-0">${iconHTML('trash-2', 18)}</button>
                    </div>
                </div>
            </div>`;
        };

        const render = () => {
            const app = document.getElementById('app');
            if (!state.isLoaded) return;

            const findNode = (nodes, id) => {
                for(let n of nodes) {
                    if (n.id === id) return n;
                    if (n.children) { const found = findNode(n.children, id); if(found) return found; }
                }
                return null;
            };
            const activeList = findNode(state.structure, state.selectedListId);

            // å´é‚Šæ¬„ä¿®å¾©ï¼šä½¿ç”¨ h-[100dvh] + flex + pb-8 (for safe area)
            const sidebarHTML = `
            <aside class="fixed md:relative inset-y-0 left-0 z-50 w-[85vw] md:w-80 bg-white flex flex-col transition-transform duration-300 shadow-[4px_0_40px_-10px_rgba(219,234,254,0.6)] ${state.isSidebarOpen ? 'translate-x-0' : '-translate-x-full md:translate-x-0'} h-[100dvh]">
                <div class="p-6 md:p-8 pb-4 flex items-center gap-3 flex-shrink-0">
                    <div class="w-12 h-12 bg-blue-100 rounded-[20px] -rotate-6 flex items-center justify-center text-blue-500 shadow-inner">${iconHTML('shopping-bag', 24)}</div>
                    <h1 class="text-xl font-black text-slate-700 tracking-wider">BlueBuy</h1>
                </div>
                
                <div class="flex-1 overflow-y-auto p-4 space-y-2 custom-scrollbar min-h-0">
                    ${state.sidebarTab === 'lists' ? `
                        <div class="flex justify-between items-center mb-3 px-2">
                            <span class="text-xs font-bold text-slate-400 uppercase tracking-widest">æˆ‘çš„æ¸…å–®</span>
                            <button data-action="create-folder" class="p-2 text-blue-400 hover:bg-blue-50 rounded-full">${iconHTML('plus', 18)}</button>
                        </div>
                        ${state.structure.map(node => renderSidebarNode(node)).join('')}
                    ` : `
                        <div class="space-y-4 px-2 animate-fade-in">
                           <div class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-2">AI æ™ºæ…§å·¥å…·</div>
                           <button data-action="open-key-settings" class="w-full flex items-center justify-center gap-2 bg-slate-100 hover:bg-slate-200 text-slate-600 py-4 rounded-2xl text-sm font-bold transition-colors mb-4 border border-slate-200">${iconHTML('settings', 16)} è¨­å®š API Key</button>
                           <button data-action="open-tool-recommend" class="w-full flex flex-col items-center justify-center gap-3 bg-gradient-to-br from-blue-400 to-blue-500 text-white py-6 rounded-3xl shadow-lg hover:scale-[1.02] transition-transform">
                               <div class="bg-white/20 p-3 rounded-full">${iconHTML('lightbulb', 28, 'text-yellow-200')}</div>
                               <span class="font-bold text-base">è³¼ç‰©é¡§å•</span>
                           </button>
                           <div class="grid grid-cols-2 gap-3">
                              <button data-action="open-tool-restaurant" class="flex flex-col items-center justify-center gap-2 bg-orange-50 text-orange-500 py-5 rounded-3xl border-2 border-orange-100">${iconHTML('utensils', 24)} <span class="text-sm font-bold">é¤å»³æ¢æŸ¥</span></button>
                              <button data-action="open-tool-social" class="flex flex-col items-center justify-center gap-2 bg-pink-50 text-pink-500 py-5 rounded-3xl border-2 border-pink-100">${iconHTML('message-circle', 24)} <span class="text-sm font-bold">ç¤¾ç¾¤åˆ†æ</span></button>
                           </div>
                           <button data-action="open-tool-import" class="w-full flex items-center justify-center gap-2 bg-white border-2 border-purple-100 text-purple-400 py-5 rounded-3xl text-sm font-bold shadow-sm">${iconHTML('sparkles', 20)} æ™ºæ…§åŒ¯å…¥</button>
                        </div>
                    `}
                </div>
                
                <div class="p-4 border-t border-slate-100 bg-white flex-shrink-0 z-10 pb-8 md:pb-4 pb-safe">
                    <div class="flex bg-slate-100 p-1 rounded-2xl">
                        <button data-action="switch-tab-lists" class="flex-1 py-3 rounded-xl text-sm font-bold flex items-center justify-center gap-2 transition-all ${state.sidebarTab === 'lists' ? 'bg-white text-blue-500 shadow-sm' : 'text-slate-400'}">${iconHTML('menu', 18)} æ¸…å–®</button>
                        <button data-action="switch-tab-tools" class="flex-1 py-3 rounded-xl text-sm font-bold flex items-center justify-center gap-2 transition-all ${state.sidebarTab === 'tools' ? 'bg-white text-blue-500 shadow-sm' : 'text-slate-400'}">${iconHTML('grid-2x2', 18)} å·¥å…·</button>
                    </div>
                </div>
            </aside>`;

            let contentHTML = '';
            if (!activeList) {
                contentHTML = `<div class="h-full flex flex-col items-center justify-center text-slate-300 gap-8 opacity-60"><div class="w-48 h-48 bg-white rounded-[3rem] flex items-center justify-center shadow-[0_20px_50px_-10px_rgba(203,213,225,0.5)]">${iconHTML('shopping-bag', 80, 'text-blue-100')}</div><p class="text-xl tracking-widest font-bold">è«‹é¸æ“‡æ¸…å–®é–‹å§‹è³¼ç‰© ğŸ›’</p></div>`;
            } else {
                const ungroupedItems = activeList.items.filter(i => !i.groupId || !activeList.groups?.find(g => g.id === i.groupId));
                contentHTML = `
                <div class="max-w-4xl mx-auto space-y-6 md:space-y-10 pb-32">
                    <div class="relative group mt-2">
                         <div class="absolute inset-y-0 left-6 flex items-center pointer-events-none">${iconHTML('plus', 26, 'text-blue-300')}</div>
                         <input type="text" id="main-input" value="${state.newItemName}" placeholder="æƒ³è¦è²·ä»€éº¼å‘¢..." class="w-full pl-16 pr-28 py-6 bg-white rounded-[2.5rem] shadow-[0_15px_35px_-10px_rgba(147,197,253,0.25)] focus:outline-none focus:ring-4 focus:ring-blue-100 transition-all text-lg placeholder:text-slate-300 text-slate-600 font-bold" onkeydown="if(event.key === 'Enter') document.querySelector('[data-action=add-main-item]').click()">
                         <button data-action="add-main-item" class="absolute right-2 top-2 bottom-2 px-6 bg-blue-400 hover:bg-blue-500 text-white rounded-[2rem] font-bold shadow-lg shadow-blue-200 transition-transform active:scale-95 text-base">åŠ å…¥</button>
                    </div>
                    <div class="${state.viewMode === 'grid' ? 'grid grid-cols-1 sm:grid-cols-2 gap-4' : 'space-y-4 md:space-y-5'}">${ungroupedItems.map(item => renderItemCard(item)).join('')}</div>
                    ${(activeList.groups || []).map(group => {
                        const gItems = activeList.items.filter(i => i.groupId === group.id);
                        return `<div class="transform transition-all">
                            <div class="flex items-center gap-4 mb-4 cursor-pointer select-none pl-2 group/header" data-action="toggle-group" data-id="${group.id}">
                                <div class="p-2.5 rounded-full transition-all shadow-sm ${group.isOpen ? 'bg-blue-100 text-blue-500' : 'bg-white text-slate-300 -rotate-90'}">${iconHTML('chevron-down', 20)}</div>
                                <h3 class="text-lg font-bold text-slate-600 flex items-center gap-3">${group.title} <span class="text-xs bg-white text-slate-400 px-3 py-1 rounded-full">${gItems.length}</span></h3>
                                <div class="flex-1 border-b-2 border-dotted border-blue-100 ml-2"></div>
                                <button data-action="delete-group" data-id="${group.id}" class="p-3 text-slate-300 hover:text-rose-400 hover:bg-rose-50 rounded-full transition-colors opacity-0 group-hover/header:opacity-100">${iconHTML('trash-2', 18)}</button>
                            </div>
                            ${group.isOpen ? `<div class="${state.viewMode === 'grid' ? 'grid grid-cols-1 sm:grid-cols-2 gap-4' : 'space-y-4 md:space-y-5'}">${gItems.map(item => renderItemCard(item)).join('')}</div>` : ''}
                        </div>`;
                    }).join('')}
                </div>`;
            }

            app.innerHTML = `
                ${state.isSidebarOpen ? '<div class="fixed inset-0 bg-slate-500/30 z-30 md:hidden backdrop-blur-sm" data-action="close-sidebar"></div>' : ''}
                ${sidebarHTML}
                <main class="flex-1 flex flex-col h-full relative w-full overflow-hidden bg-[#FFF9F5]">
                    <header class="h-20 md:h-24 flex items-center px-4 md:px-8 justify-between sticky top-0 z-20 bg-[#FFF9F5]/90 backdrop-blur-md">
                        <div class="flex items-center gap-3 md:gap-5 flex-1 min-w-0">
                            <button data-action="toggle-sidebar" class="md:hidden p-3 -ml-2 text-slate-400 hover:bg-white rounded-2xl active:scale-95 transition-transform">${iconHTML('list', 28)}</button>
                            <h2 class="text-xl md:text-2xl font-black text-slate-700 truncate">${activeList ? activeList.title : 'é¸æ“‡æ¸…å–®'}</h2>
                        </div>
                        <div class="flex items-center gap-2 md:gap-3">
                            <div class="hidden md:flex items-center gap-1.5 text-xs font-bold px-4 py-2 rounded-full transition-colors ${state.isSaving ? 'text-blue-400 bg-blue-50' : 'text-slate-300'}">${state.isSaving ? `${iconHTML('loader-2', 12, 'animate-spin')} å„²å­˜ä¸­` : `${iconHTML('cloud', 12)} å·²åŒæ­¥`}</div>
                            <button data-action="toggle-view" class="p-3 rounded-2xl bg-white text-slate-500 shadow-sm border border-slate-100 active:scale-95 transition-transform">${state.viewMode === 'list' ? iconHTML('layout-grid', 22) : iconHTML('align-justify', 22)}</button>
                            ${activeList ? `<button data-action="create-group" class="ml-1 flex items-center gap-2 text-sm font-bold text-slate-500 hover:text-blue-500 bg-white hover:bg-blue-50 px-4 py-3 rounded-2xl shadow-sm border border-slate-100 active:scale-95 transition-transform">${iconHTML('layers', 20)} <span class="hidden sm:inline">åˆ†å€</span></button>` : ''}
                        </div>
                    </header>
                    <div class="flex-1 overflow-y-auto px-4 md:px-8 scroll-smooth custom-scrollbar pb-safe">${contentHTML}</div>
                </main>
            `;
            refreshIcons();
        };

        // --- Modals Logic ---
        const showDialog = (type, title, message, onConfirm) => {
            const overlay = document.getElementById('dialog-overlay');
            overlay.innerHTML = `
            <div class="fixed inset-0 bg-black/40 z-[100] flex items-center justify-center p-4 animate-fade-in">
                <div class="bg-white rounded-[2rem] shadow-2xl w-full max-w-sm p-6 border-4 border-white/50">
                    <div class="flex flex-col items-center text-center gap-3 mb-5">
                        <div class="w-14 h-14 ${type === 'confirm' ? 'bg-rose-100 text-rose-500' : 'bg-blue-100 text-blue-500'} rounded-full flex items-center justify-center">${iconHTML(type === 'confirm' ? 'alert-triangle' : 'edit-3', 28)}</div>
                        <h3 class="text-lg font-bold text-slate-700">${title}</h3>
                    </div>
                    <p class="text-slate-600 mb-6 text-center font-medium text-base leading-relaxed">${message}</p>
                    ${type === 'prompt' ? `<input type="text" id="dialog-input" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl mb-6 focus:ring-2 focus:ring-blue-400 text-slate-700 text-center outline-none font-bold text-lg" placeholder="è¼¸å…¥..." autofocus>` : ''}
                    <div class="flex justify-center gap-3">
                        <button id="dialog-cancel" class="flex-1 py-4 text-slate-500 hover:bg-slate-100 rounded-2xl font-bold transition-colors text-base">å–æ¶ˆ</button>
                        <button id="dialog-confirm" class="flex-1 py-4 text-white rounded-2xl font-bold shadow-md ${type === 'confirm' ? 'bg-rose-500 hover:bg-rose-600' : 'bg-blue-500 hover:bg-blue-600'} text-base">ç¢ºèª</button>
                    </div>
                </div>
            </div>`;
            refreshIcons();
            const close = () => overlay.innerHTML = '';
            document.getElementById('dialog-cancel').onclick = close;
            document.getElementById('dialog-confirm').onclick = () => { const val = document.getElementById('dialog-input')?.value; onConfirm(val); close(); };
        };

        const showMoveTargetModal = (mode = 'move-item') => {
             const overlay = document.getElementById('modal-overlay');
             const renderTargets = (nodes, depth=0) => {
                 return nodes.map(n => {
                     const pl = depth * 12;
                     if(mode === 'move-list' && n.type === 'folder') {
                        const isCurrent = state.moveTarget?.currentParentId === n.id;
                        return `<div class="mb-2"><button class="w-full text-left p-4 rounded-2xl flex items-center gap-3 border border-transparent ${isCurrent ? 'opacity-50 bg-slate-50':'hover:bg-blue-50 cursor-pointer'}" style="margin-left:${pl}px" onclick="${isCurrent?'':'window.confirmMove(\''+n.id+'\')'}"><div class="w-8 h-8 bg-blue-50 rounded-full flex items-center justify-center text-blue-400">${iconHTML('folder',16)}</div><span class="font-bold text-slate-600 text-base">${n.title}</span></button>${n.children?renderTargets(n.children, depth+1):''}</div>`;
                     }
                     if((mode === 'move-item' || mode === 'add-tool') && n.type === 'list') {
                        const isCurrent = state.moveTarget?.currentParentId === n.id;
                        return `<button class="w-full text-left p-4 rounded-2xl flex items-center gap-3 border border-transparent mb-2 ${isCurrent ? 'opacity-50 bg-slate-50':'hover:bg-blue-50 cursor-pointer'}" style="margin-left:${pl}px" onclick="${isCurrent?'':'window.confirmMove(\''+n.id+'\')'}"><div class="w-8 h-8 bg-white rounded-full flex items-center justify-center text-blue-400 border border-slate-100">${iconHTML('list',16)}</div><span class="font-bold text-slate-600 text-base">${n.title}</span></button>`;
                     }
                     if((mode === 'move-item' || mode === 'add-tool') && n.type === 'folder') {
                        return `<div class="mb-2"><div class="px-3 py-1 text-xs font-bold text-slate-400 uppercase flex items-center gap-1" style="margin-left:${pl}px">${iconHTML('folder',12)} ${n.title}</div>${n.children?renderTargets(n.children, depth+1):''}</div>`;
                     }
                     return '';
                 }).join('');
             };

             overlay.innerHTML = `
             <div class="fixed inset-0 bg-black/40 z-[80] flex items-center justify-center p-4 animate-fade-in">
                <div class="bg-white rounded-[2.5rem] shadow-2xl w-full max-w-sm flex flex-col max-h-[80vh] border-4 border-white/50">
                    <div class="p-5 border-b border-slate-100 bg-white/90 rounded-t-[2.2rem]"><h3 class="text-lg font-bold text-slate-700 text-center">${mode === 'move-list' ? 'ç§»å‹•æ¸…å–®åˆ°...' : 'é¸æ“‡ç›®æ¨™æ¸…å–®'}</h3></div>
                    <div class="flex-1 overflow-y-auto p-4 custom-scrollbar bg-slate-50/50">
                        ${mode === 'move-list' ? `<button class="w-full text-left p-4 rounded-2xl flex items-center gap-3 border border-transparent mb-2 ${state.moveTarget?.currentParentId==='root'?'opacity-50 bg-slate-50':'hover:bg-blue-50 cursor-pointer'}" onclick="window.confirmMove('root')"><div class="w-8 h-8 bg-slate-100 rounded-full flex items-center justify-center text-slate-500">${iconHTML('layers',16)}</div><span class="font-bold text-slate-600 text-base">æœ€ä¸Šå±¤ (æ ¹ç›®éŒ„)</span></button>` : ''}
                        ${renderTargets(state.structure)}
                    </div>
                    <div class="p-4 border-t border-slate-100 bg-white rounded-b-[2.2rem]"><button id="move-cancel" class="w-full py-4 text-slate-400 hover:bg-slate-50 rounded-2xl font-bold text-base">å–æ¶ˆ</button></div>
                </div>
             </div>`;
             refreshIcons();
             document.getElementById('move-cancel').onclick = () => { state.moveTarget = null; state.pendingItemToAdd = null; overlay.innerHTML = ''; };
             window.confirmMove = (targetId) => {
                 if(state.pendingItemToAdd) confirmToolAddItem(targetId); else executeMove(targetId);
                 overlay.innerHTML = '';
             };
        };

        const showSocialModal = () => {
             const overlay = document.getElementById('modal-overlay');
             overlay.innerHTML = `
             <div class="fixed inset-0 bg-black/50 z-[60] flex items-center justify-center p-4">
                <div class="bg-[#FFF9F5] rounded-[2.5rem] shadow-2xl w-full max-w-lg h-[80vh] flex flex-col border-4 border-white overflow-hidden">
                    <div class="p-5 bg-white border-b border-pink-50 flex items-center justify-between">
                         <h3 class="font-bold flex gap-2 text-slate-700">${iconHTML('message-circle', 24, 'text-pink-400')} ç¤¾ç¾¤åˆ†æ</h3>
                         <button id="social-close" class="p-2 rounded-full hover:bg-slate-100">${iconHTML('x', 20)}</button>
                    </div>
                    <div id="social-content" class="flex-1 p-6 overflow-y-auto bg-[#FDFBF7]">
                        <div class="h-full flex flex-col items-center justify-center text-slate-400 gap-4">
                             <div class="w-16 h-16 bg-pink-50 rounded-full flex items-center justify-center">${iconHTML('heart', 32, 'text-pink-300')}</div>
                             <p>è²¼ä¸Š IG/Threads é€£çµæˆ–æ–‡å­—<br>åˆ†æç•™è¨€é¢¨å‘èˆ‡é‡é»ï¼</p>
                        </div>
                    </div>
                    <div class="p-5 bg-white border-t border-pink-50 flex gap-2">
                        <input id="social-input" type="text" class="flex-1 p-4 bg-slate-50 rounded-full outline-none text-base" placeholder="è²¼ä¸Šå…§å®¹...">
                        <button id="social-go" class="w-14 h-14 bg-pink-400 text-white rounded-full shadow-lg flex items-center justify-center hover:bg-pink-500 transition-transform active:scale-95">${iconHTML('wand-2', 24)}</button>
                    </div>
                </div>
             </div>`;
             refreshIcons();
             document.getElementById('social-close').onclick = () => overlay.innerHTML = '';
             document.getElementById('social-go').onclick = async function() {
                 const query = document.getElementById('social-input').value;
                 if(!query) return;
                 const btn = this;
                 const content = document.getElementById('social-content');
                 btn.innerHTML = iconHTML('loader-2', 24, 'animate-spin');
                 
                 try {
                     const prompt = `Analyze: "${query}". JSON: { "summary": "str", "sentiment": "Positive/Neutral/Negative", "key_comments": [{"user":"A","content":"txt","likes":10}], "engagement": "str" }`;
                     const res = await callGemini(prompt);
                     if(res) {
                         content.innerHTML = `
                         <div class="space-y-5 animate-fade-in">
                            <div class="bg-white p-5 rounded-3xl shadow-sm border border-pink-100">
                                <div class="flex justify-between items-center mb-3"><h4 class="font-bold text-slate-700">ğŸ“ æ‘˜è¦</h4><span class="text-xs px-2 py-1 rounded-full font-bold bg-slate-100">${res.sentiment}</span></div>
                                <p class="text-sm text-slate-600 mb-3">${res.summary}</p>
                                <div class="flex items-center gap-2 text-xs font-bold text-pink-500 bg-pink-50 px-3 py-1.5 rounded-xl w-fit">${iconHTML('thumbs-up',12)} ${res.engagement}</div>
                            </div>
                            <div class="space-y-3"><h4 class="text-sm font-bold text-slate-500 ml-1">ğŸ’¬ æ¨¡æ“¬ç•™è¨€</h4>${res.key_comments.map(c=>`<div class="bg-white p-4 rounded-2xl border border-slate-100 flex gap-3"><div class="w-8 h-8 bg-slate-100 rounded-full flex-shrink-0 flex items-center justify-center text-[10px] font-bold text-slate-400">${c.user[0]}</div><div class="flex-1"><div class="flex justify-between"><span class="text-xs font-bold text-slate-700">${c.user}</span><span class="text-[10px] text-slate-400 flex items-center gap-1">${iconHTML('heart',8)} ${c.likes}</span></div><p class="text-xs text-slate-500 mt-1">${c.content}</p></div></div>`).join('')}</div>
                         </div>`;
                     }
                 } catch(e) { alert("åˆ†æå¤±æ•—"); }
                 btn.innerHTML = iconHTML('wand-2', 24);
                 refreshIcons();
             };
        };
        
        const showEditor = (item) => {
             const overlay = document.getElementById('modal-overlay');
             const groups = state.structure.flatMap(n => n.children ? [n, ...n.children] : [n]).find(n => n.id === state.selectedListId)?.groups || [];
             
             overlay.innerHTML = `
            <div class="fixed inset-0 bg-black/30 backdrop-blur-sm z-50 flex justify-end animate-fade-in">
                <div class="w-full max-w-md bg-[#FFF9F5] h-full shadow-2xl flex flex-col border-l-4 border-white">
                    <div class="p-5 border-b border-blue-50 flex items-center justify-between bg-white z-10">
                        <h3 class="text-base font-bold text-slate-700 flex items-center gap-2"><span class="bg-blue-100 p-2 rounded-xl text-blue-500">${iconHTML('edit-3', 20)}</span> ç·¨è¼¯å¥½ç‰©</h3>
                        <div class="flex items-center gap-2"><button id="editor-save" class="bg-blue-500 hover:bg-blue-600 text-white px-5 py-2 rounded-full font-bold shadow-md text-sm flex items-center gap-1">${iconHTML('check', 16)} å„²å­˜</button><button id="editor-close" class="p-2 hover:bg-slate-100 rounded-full text-slate-400">${iconHTML('x', 24)}</button></div>
                    </div>
                    <div class="flex-1 overflow-y-auto p-6 space-y-6 custom-scrollbar pb-20">
                        <div class="space-y-3"><label class="text-xs font-bold text-slate-400 uppercase ml-1">å•†å“åç¨±</label><div class="flex gap-2"><input id="edit-name" type="text" value="${item.name}" class="flex-1 w-full p-4 bg-white border-2 border-transparent focus:border-blue-200 rounded-2xl focus:outline-none shadow-sm text-slate-700 font-bold text-lg"><button id="edit-magic" class="bg-gradient-to-br from-indigo-400 to-purple-400 text-white p-4 rounded-2xl shadow-md hover:scale-105 transition-transform w-16 flex justify-center items-center">${iconHTML('wand-2', 24)}</button></div></div>
                        <div class="space-y-2"><label class="text-xs font-bold text-slate-400 uppercase ml-1">åˆ†é¡</label><div class="relative"><select id="edit-group" class="w-full p-4 pl-12 bg-white border-0 rounded-2xl shadow-sm appearance-none text-slate-600 font-medium text-base"><option value="">æœªåˆ†é¡</option>${groups.map(g => `<option value="${g.id}" ${item.groupId === g.id ? 'selected' : ''}>${g.title}</option>`).join('')}</select><div class="absolute left-4 top-4 text-blue-300 pointer-events-none">${iconHTML('tag', 18)}</div><div class="absolute right-4 top-4 text-slate-300 pointer-events-none">${iconHTML('chevron-down', 18)}</div></div></div>
                        <div class="grid grid-cols-2 gap-3"><div class="space-y-2"><label class="text-xs font-bold text-slate-400 uppercase ml-1">åƒ¹æ ¼</label><input id="edit-price" type="number" value="${item.price}" class="w-full p-4 bg-white border-0 rounded-2xl shadow-sm text-slate-700 font-bold text-lg"></div><div class="space-y-2"><label class="text-xs font-bold text-slate-400 uppercase ml-1">è²¨å¹£</label><select id="edit-currency" class="w-full p-4 bg-white border-0 rounded-2xl shadow-sm appearance-none text-slate-600 font-medium text-lg"><option value="TWD" ${item.currency==='TWD'?'selected':''}>TWD</option><option value="JPY" ${item.currency==='JPY'?'selected':''}>JPY</option></select></div></div>
                        <div class="space-y-2"><label class="text-xs font-bold text-slate-400 uppercase ml-1">å‚™è¨»</label><textarea id="edit-note" rows="3" class="w-full p-4 bg-white border-0 rounded-2xl shadow-sm resize-none text-slate-600 text-base">${item.note||''}</textarea></div>
                    </div>
                </div>
            </div>`;
            refreshIcons();
            document.getElementById('editor-close').onclick = () => overlay.innerHTML = '';
            document.getElementById('editor-save').onclick = () => {
                const updated = { ...item, name: document.getElementById('edit-name').value, price: Number(document.getElementById('edit-price').value), currency: document.getElementById('edit-currency').value, note: document.getElementById('edit-note').value, groupId: document.getElementById('edit-group').value || null };
                updateItemInState(updated);
                overlay.innerHTML = '';
            };
            document.getElementById('edit-magic').onclick = async function() {
                const btn = this; const name = document.getElementById('edit-name').value; if(!name) return;
                btn.innerHTML = iconHTML('loader-2', 24, 'animate-spin');
                try {
                     const res = await callGemini(`Item: "${name}". Return JSON: { "price": number_twd, "note": "short tip" }`);
                     if(res) { document.getElementById('edit-price').value = res.price||0; document.getElementById('edit-note').value = res.note||''; }
                } catch(e){}
                btn.innerHTML = iconHTML('wand-2', 24);
                refreshIcons();
            }
        };

        const showAIImportModal = () => {
             const overlay = document.getElementById('modal-overlay');
             overlay.innerHTML = `<div class="fixed inset-0 bg-black/50 z-[60] flex items-center justify-center p-4"><div class="bg-[#FFF9F5] rounded-[2.5rem] shadow-2xl w-full max-w-lg border-4 border-white overflow-hidden"><div class="p-6 bg-white/80 border-b border-purple-50"><h3 class="text-base font-bold flex items-center gap-2 text-slate-700">${iconHTML('sparkles', 24, 'text-purple-400')} AI æ™ºæ…§åŒ¯å…¥</h3><p class="text-slate-500 text-sm mt-2">è²¼ä¸Šæ–‡å­—ï¼ŒAI å¹«ä½ æ•´ç†æˆæ¸…å–®ï¼</p></div><div class="p-6 space-y-4"><textarea id="import-text" class="w-full h-48 p-4 bg-white border-0 rounded-3xl shadow-inner text-slate-600 resize-none outline-none text-base" placeholder="ä¾‹å¦‚ï¼šæ˜å¤©è¦è²·é›è›‹ã€ç‰›å¥¶..."></textarea><div class="flex justify-end gap-3"><button id="import-cancel" class="px-6 py-4 text-slate-400 hover:bg-slate-100 rounded-2xl font-bold text-base">å–æ¶ˆ</button><button id="import-go" class="px-8 py-4 bg-purple-400 hover:bg-purple-500 text-white rounded-2xl font-bold shadow-lg flex items-center gap-2 text-base">${iconHTML('sparkles', 18)} é–‹å§‹è§£æ</button></div></div></div></div>`;
             refreshIcons();
             document.getElementById('import-cancel').onclick = () => overlay.innerHTML = '';
             document.getElementById('import-go').onclick = async function() {
                 const text = document.getElementById('import-text').value; if(!text.trim()) return;
                 this.innerHTML = `${iconHTML('loader-2', 18, 'animate-spin')} è™•ç†ä¸­...`; refreshIcons();
                 try {
                     const res = await callGemini(`Extract list from: "${text}". JSON: { "items": [{ "name": "str", "price": 0, "note": "str" }] }`);
                     if(res && res.items) {
                         state.pendingItemToAdd = { isBatch: true, items: res.items, name: `${res.items.length} å€‹é …ç›®` };
                         overlay.innerHTML = '';
                         showMoveTargetModal('add-tool');
                     }
                 } catch(e) { alert("è§£æå¤±æ•—"); }
                 this.innerHTML = `${iconHTML('sparkles', 18)} é–‹å§‹è§£æ`;
             };
        };

        const showRestaurantModal = () => {
             const overlay = document.getElementById('modal-overlay');
             overlay.innerHTML = `<div class="fixed inset-0 bg-black/50 z-[60] flex items-center justify-center p-4"><div class="bg-[#FFF9F5] rounded-[2.5rem] shadow-2xl w-full max-w-lg h-[80vh] flex flex-col border-4 border-white overflow-hidden"><div class="p-5 bg-white border-b border-orange-50 flex items-center justify-between"><h3 class="font-bold flex gap-2 text-slate-700">${iconHTML('utensils', 24, 'text-orange-400')} é¤å»³æ¢æŸ¥</h3><button id="rest-close" class="p-2 rounded-full hover:bg-slate-100">${iconHTML('x', 20)}</button></div><div id="rest-content" class="flex-1 p-6 overflow-y-auto bg-[#FDFBF7]"><div class="h-full flex flex-col items-center justify-center text-slate-400 gap-4"><div class="w-16 h-16 bg-orange-100 rounded-full flex items-center justify-center">${iconHTML('map-pin', 32, 'text-orange-400')}</div><p>è¼¸å…¥é¤å»³åç¨±ï¼ŒAI åˆ†æè©•åƒ¹èˆ‡èœè‰²</p></div></div><div class="p-5 bg-white border-t border-orange-50 flex gap-2"><input id="rest-input" type="text" class="flex-1 p-4 bg-slate-50 rounded-full outline-none text-base" placeholder="è¼¸å…¥é¤å»³åç¨±..."><button id="rest-go" class="w-14 h-14 bg-orange-400 text-white rounded-full shadow-lg flex items-center justify-center hover:bg-orange-500 transition-transform active:scale-95">${iconHTML('search', 24)}</button></div></div></div>`;
             refreshIcons();
             document.getElementById('rest-close').onclick = () => overlay.innerHTML = '';
             document.getElementById('rest-go').onclick = async function() {
                 const q = document.getElementById('rest-input').value; if(!q) return;
                 const btn = this; const content = document.getElementById('rest-content');
                 btn.innerHTML = iconHTML('loader-2', 24, 'animate-spin');
                 try {
                     const res = await callGemini(`Restaurant "${q}". JSON: { "name": "str", "rating": 4.5, "summary": "zh_sum", "dishes": ["d1", "d2"] }`, null, true);
                     if(res) {
                         content.innerHTML = `<div class="space-y-4 animate-fade-in"><h2 class="text-xl font-bold text-slate-800">${res.name} â˜…${res.rating}</h2><p class="p-4 bg-white rounded-2xl shadow-sm text-slate-600 text-sm">${res.summary}</p><div class="grid gap-2">${res.dishes.map(d=>`<button class="bg-white p-3 rounded-xl shadow-sm flex justify-between font-bold text-slate-700 w-full text-left" onclick="window.addRestItem('${d}')">${d} ${iconHTML('plus',16)}</button>`).join('')}</div></div>`;
                         window.addRestItem = (n) => { state.pendingItemToAdd={name:n, note:`ä¾†è‡ª ${res.name}`}; showMoveTargetModal('add-tool'); };
                         refreshIcons();
                     }
                 } catch(e) { alert("æŸ¥è©¢å¤±æ•—"); }
                 btn.innerHTML = iconHTML('search', 24);
             };
        };

        // --- Data Logic ---
        const saveData = async (newStructure) => {
            state.structure = newStructure; state.isSaving = true; render();
            if (state.user && db) { try { await setDoc(doc(db, 'artifacts', APP_ID, 'users', state.user.uid, 'data', 'shopping_list'), { structure: newStructure }, { merge: true }); } catch (e) {} }
            setTimeout(() => { state.isSaving = false; render(); }, 500);
        };
        const updateDeep = (nodes, id, cb) => nodes.map(n => { if (n.id === id) return cb(n); if (n.children) return { ...n, children: updateDeep(n.children, id, cb) }; return n; });
        const updateItemInActiveList = (cb) => { if (state.selectedListId) saveData(updateDeep(state.structure, state.selectedListId, n => ({ ...n, items: cb(n.items) }))); };
        const addItemToActiveList = (itemData) => { if (!state.selectedListId) return alert("è«‹å…ˆé¸æ“‡æ¸…å–®"); updateItemInActiveList(items => [{ id: generateId(), currency: 'TWD', checked: false, groupId: null, ...itemData }, ...items]); state.newItemName = ''; render(); };
        const updateItemInState = (item) => updateItemInActiveList(items => items.map(i => i.id === item.id ? item : i));
        
        const executeMove = (targetId) => {
             const target = state.moveTarget;
             let newStructure = JSON.parse(JSON.stringify(state.structure));
             
             if(target.type === 'move-list') {
                 let listNode = null;
                 const remove = (nodes) => nodes.filter(n => { if(n.id === target.id){ listNode=n; return false; } if(n.children) n.children=remove(n.children); return true; });
                 newStructure = remove(newStructure);
                 if(listNode) {
                     if(targetId === 'root') newStructure.push(listNode);
                     else {
                         const add = (nodes) => nodes.map(n => { if(n.id === targetId) { n.children = [...(n.children||[]), listNode]; } else if(n.children) n.children=add(n.children); return n; });
                         newStructure = add(newStructure);
                     }
                 }
             } else if(target.type === 'move-item') {
                 const remove = (nodes) => nodes.map(n => { if(n.type==='list' && n.items) n.items = n.items.filter(i=>i.id !== target.id); if(n.children) n.children=remove(n.children); return n; });
                 newStructure = remove(newStructure);
                 const add = (nodes) => nodes.map(n => { if(n.id === targetId) n.items.unshift({ ...target.itemData, groupId: null }); if(n.children) n.children=add(n.children); return n; });
                 newStructure = add(newStructure);
             }
             saveData(newStructure);
        };

        const confirmToolAddItem = (targetListId) => {
            const item = state.pendingItemToAdd;
            const newItems = item.isBatch ? item.items.map(i=>({id:generateId(), ...i, checked:false, groupId:null})) : [{id:generateId(), ...item, checked:false, groupId:null}];
            const addDeep = (nodes) => nodes.map(n => { if (n.id === targetListId) return { ...n, items: [...newItems, ...n.items] }; if (n.children) return { ...n, children: addDeep(n.children) }; return n; });
            saveData(addDeep(state.structure));
            state.pendingItemToAdd = null;
            state.selectedListId = targetListId;
            alert("å·²åŠ å…¥æ¸…å–®ï¼");
        };

        // --- Event Delegation ---
        document.addEventListener('click', (e) => {
            const el = e.target.closest('[data-action]'); if (!el) return;
            const action = el.dataset.action, id = el.dataset.id;

            switch(action) {
                // Sidebar
                case 'toggle-sidebar': state.isSidebarOpen = !state.isSidebarOpen; render(); break;
                case 'close-sidebar': state.isSidebarOpen = false; render(); break;
                case 'switch-tab-lists': state.sidebarTab = 'lists'; render(); break;
                case 'switch-tab-tools': state.sidebarTab = 'tools'; render(); break;
                case 'select-list': state.selectedListId = id; if(window.innerWidth < 768) state.isSidebarOpen = false; render(); break;
                case 'toggle-folder': saveData(updateDeep(state.structure, id, n => ({ ...n, isOpen: !n.isOpen }))); break;
                case 'create-folder': showDialog('prompt', 'æ–°å¢è³‡æ–™å¤¾', 'åç¨±', val => val && saveData([...state.structure, { id: generateId(), type: 'folder', title: val, isOpen: true, children: [] }])); break;
                case 'add-list-to-folder': e.stopPropagation(); showDialog('prompt', 'æ–°å¢æ¸…å–®', 'åç¨±', val => { if(!val)return; const newList={id:generateId(),type:'list',title:val,items:[],groups:[]}; saveData(updateDeep(state.structure, id, n=>({...n, isOpen:true, children:[...(n.children||[]), newList]}))); state.selectedListId=newList.id; render(); }); break;
                case 'delete-node': e.stopPropagation(); showDialog('confirm', 'åˆªé™¤', 'ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ', () => { const filter=(ns)=>ns.filter(n=>n.id!==id).map(n=>({...n, children:n.children?filter(n.children):undefined})); saveData(filter(state.structure)); if(state.selectedListId===id){state.selectedListId=null;render();} }); break;
                case 'rename-node': e.stopPropagation(); showDialog('prompt', 'é‡æ–°å‘½å', 'æ–°åç¨±', val => val && saveData(updateDeep(state.structure, id, n=>({...n, title:val})))); break;
                
                // Move Logic
                case 'move-list': e.stopPropagation(); {
                     const findP = (nodes, pid) => { for(let n of nodes){ if(n.id===id) return pid; if(n.children){const f=findP(n.children, n.id); if(f) return f;} } return null; };
                     const pid = findP(state.structure, 'root') || 'root';
                     state.moveTarget = { type: 'move-list', id: id, currentParentId: pid };
                     showMoveTargetModal('move-list');
                } break;
                case 'move-item': e.stopPropagation(); {
                     const list = state.structure.flatMap(f=>f.children?[f,...f.children]:[f]).find(l=>l.id===state.selectedListId);
                     const item = list.items.find(i=>i.id===id);
                     state.moveTarget = { type: 'move-item', id: id, currentParentId: state.selectedListId, itemData: item };
                     showMoveTargetModal('move-item');
                } break;

                // Main
                case 'toggle-view': state.viewMode = state.viewMode === 'list' ? 'grid' : 'list'; render(); break;
                case 'add-main-item': const v = document.getElementById('main-input').value; if(v) addItemToActiveList({ name: v }); break;
                case 'create-group': showDialog('prompt', 'æ–°å¢åˆ†å€', 'åç¨±', val => val && saveData(updateDeep(state.structure, state.selectedListId, n=>({...n, groups:[...(n.groups||[]), {id:generateId(), title:val, isOpen:true}]})))) ; break;
                case 'toggle-group': saveData(updateDeep(state.structure, state.selectedListId, n=>({...n, groups:n.groups.map(g=>g.id===id?{...g, isOpen:!g.isOpen}:g)}))); break;
                case 'delete-group': e.stopPropagation(); showDialog('confirm','åˆªé™¤åˆ†é¡','å•†å“æœƒè®Šç‚ºæœªåˆ†é¡', () => saveData(updateDeep(state.structure, state.selectedListId, n=>({...n, groups:n.groups.filter(g=>g.id!==id), items:n.items.map(i=>i.groupId===id?{...i,groupId:null}:i)})))); break;
                
                // Items
                case 'toggle-check': e.stopPropagation(); updateItemInActiveList(items => items.map(i => i.id === id ? { ...i, checked: !i.checked } : i)); break;
                case 'delete-item': e.stopPropagation(); showDialog('confirm', 'åˆªé™¤å•†å“', 'ç¢ºå®šï¼Ÿ', () => updateItemInActiveList(items => items.filter(i => i.id !== id))); break;
                case 'edit-item': 
                    const list = state.structure.flatMap(f=>f.children?[f,...f.children]:[f]).find(l=>l.id===state.selectedListId);
                    const item = list?.items.find(i=>i.id===id);
                    if(item) showEditor(item);
                    break;

                // Tools
                case 'open-key-settings': showApiKeyModal(); break;
                case 'open-tool-import': showAIImportModal(); break;
                case 'open-tool-recommend': alert("è«‹ä½¿ç”¨ã€Œæ™ºæ…§åŒ¯å…¥ã€æˆ–ã€Œé¤å»³æ¢æŸ¥ã€åŠŸèƒ½"); break;
                case 'open-tool-restaurant': showRestaurantModal(); break;
                case 'open-tool-social': showSocialModal(); break;
            }
        });

        // --- Init ---
        if (auth) {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    state.user = user;
                    const docRef = doc(db, 'artifacts', APP_ID, 'users', user.uid, 'data', 'shopping_list');
                    onSnapshot(docRef, (snap) => {
                        if (snap.exists()) state.structure = snap.data().structure;
                        else { state.structure = mockStructure; setDoc(docRef, { structure: mockStructure }); }
                        state.isLoaded = true; render();
                    });
                } else signInAnonymously(auth);
            });
        } else { state.structure = mockStructure; state.isLoaded = true; render(); }

        document.addEventListener('input', (e) => { if(e.target.id === 'main-input') state.newItemName = e.target.value; });

    </script>
</body>
</html>